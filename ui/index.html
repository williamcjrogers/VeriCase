<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VeriCase Docs Workspace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f6fb;
      --surface: #ffffff;
      --subsurface: #f8fafc;
      --text: #111827;
      --muted: #64748b;
      --muted-strong: #475569;
      --border: #e2e8f0;
      --accent: #2563eb;
      --accent-strong: #1d4ed8;
      --accent-soft: rgba(37, 99, 235, 0.12);
      --danger: #ef4444;
      --success: #10b981;
      --shadow-sm: 0 2px 6px rgba(15, 23, 42, 0.08);
      --shadow-md: 0 16px 32px rgba(15, 23, 42, 0.1);
      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 20px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #edf2fb 0%, #f8fafc 45%, #eef2ff 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    header .session {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    header .logo strong {
      font-size: 1.1rem;
      letter-spacing: -0.01em;
    }

    header .logo span {
      color: var(--muted);
      font-size: 0.8rem;
    }

    header .session {
      gap: 1rem;
    }

    header .session span {
      color: var(--muted);
      font-size: 0.85rem;
      letter-spacing: 0.02em;
    }

    header .session button {
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(255, 255, 255, 0.85);
      padding: 0.45rem 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    header .session button:hover {
      border-color: rgba(37, 99, 235, 0.35);
      color: var(--accent);
    }

    .shell {
      flex: 1;
      display: grid;
      grid-template-columns: clamp(220px, 18vw, 280px) 1fr;
      min-height: 0;
      padding: 1.5rem 2rem 2rem;
      gap: 1.5rem;
    }

    aside {
      border-right: 1px solid rgba(148, 163, 184, 0.18);
      background: rgba(255, 255, 255, 0.85);
      display: flex;
      flex-direction: column;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      min-height: 0;
    }

    .nav-section {
      padding: 1.4rem 1.6rem 0.6rem;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted-strong);
    }

    .nav-list {
      padding: 0 0.9rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .nav-list button {
      border: none;
      background: transparent;
      padding: 0.65rem 0.9rem;
      border-radius: var(--radius-sm);
      text-align: left;
      font-weight: 500;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.55rem;
      letter-spacing: 0.01em;
    }

    .nav-list button:hover,
    .nav-list button.active {
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent);
      box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.18);
    }

    .tree {
      flex: 1;
      overflow-y: auto;
      padding: 0 1.2rem 1.5rem;
      scrollbar-width: thin;
    }

    .tree-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.2rem 1.2rem 0.8rem;
      color: var(--muted);
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .tree-header button {
      border: none;
      background: rgba(148, 163, 184, 0.12);
      color: var(--muted-strong);
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.85rem;
      line-height: 1;
    }

    .tree-header button:hover {
      background: rgba(37, 99, 235, 0.15);
      color: var(--accent-strong);
    }

    .tree-item {
      padding: 0.45rem 0.55rem;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      gap: 0.45rem;
      cursor: pointer;
      color: var(--muted);
      font-size: 0.92rem;
      transition: all 0.2s ease;
    }

    .tree-item.active,
    .tree-item:hover {
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
    }

    .tree-item .caret {
      width: 14px;
      font-size: 0.75rem;
      text-align: center;
      color: #94a3b8;
    }
    .tree-item .caret.invisible {
      color: transparent;
    }

    main {
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      min-height: 0;
    }

    .crumbs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .crumbs button {
      border: none;
      background: rgba(148, 163, 184, 0.18);
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      font-weight: 500;
      cursor: pointer;
      color: inherit;
    }

    .crumbs button:hover {
      background: rgba(37, 99, 235, 0.2);
      color: var(--accent);
    }

    .workspace-head {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 1.2rem;
      align-items: flex-end;
      padding: 1.4rem 1.6rem;
      background: rgba(255, 255, 255, 0.92);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(148, 163, 184, 0.16);
    }

    .workspace-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .workspace-actions button {
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--radius-sm);
      padding: 0.55rem 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }

    .workspace-actions button:hover {
      border-color: rgba(37, 99, 235, 0.35);
      color: var(--accent);
    }

    .workspace-actions button.primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 6px 18px rgba(37, 99, 235, 0.35);
    }

    .workspace-actions button.primary:hover {
      background: var(--accent-strong);
    }

    .table-card {
      background: var(--surface);
      border: 1px solid rgba(148, 163, 184, 0.16);
      border-radius: var(--radius-lg);
      overflow: hidden;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-md);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    thead {
      background: #f1f5f9;
    }

    th, td {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    tbody tr:hover td {
      background: rgba(241, 245, 249, 0.65);
    }

    tbody tr.selected td {
      background: rgba(37, 99, 235, 0.12);
      border-bottom-color: rgba(37, 99, 235, 0.25);
    }

    td button {
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(249, 250, 251, 0.8);
      border-radius: var(--radius-sm);
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      margin-left: 0.35rem;
      transition: all 0.2s ease;
    }

    td button:hover {
      border-color: rgba(37, 99, 235, 0.35);
      color: var(--accent);
      background: rgba(237, 242, 255, 0.7);
    }

    #doc-table-empty {
      padding: 2rem;
      text-align: center;
      color: var(--muted);
      display: none;
    }

    .upload-status {
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: var(--radius-sm);
      padding: 0.75rem 0.9rem;
      margin-top: 0.65rem;
      box-shadow: var(--shadow-sm);
    }

    .upload-status strong {
      display: block;
      font-weight: 600;
      margin-bottom: 0.35rem;
      color: var(--muted-strong);
      word-break: break-word;
    }

    .upload-status span {
      font-size: 0.85rem;
      color: var(--muted);
      display: block;
    }

    .upload-status span.success {
      color: var(--success);
    }

    .upload-status span.error {
      color: var(--danger);
    }

    .auth-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(14px);
      padding: 2.5rem;
      z-index: 20;
    }

    .auth-card {
      width: min(460px, 100%);
      background: rgba(255, 255, 255, 0.96);
      border-radius: var(--radius-lg);
      padding: 2.4rem;
      box-shadow: 0 26px 48px rgba(15, 23, 42, 0.25);
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    input[type="email"],
    input[type="password"],
    input[type="text"],
    input[type="search"] {
      width: 100%;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 0.7rem 0.9rem;
      font-size: 0.9rem;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.95);
      transition: all 0.2s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
    }

    .hidden { display: none !important; }

    body.authed .auth-overlay { display: none; }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.15);
      padding: 0.5rem 0;
      min-width: 180px;
      z-index: 1000;
    }

    .context-menu-item {
      padding: 0.6rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.9rem;
      transition: all 0.15s ease;
    }

    .context-menu-item:hover {
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .context-menu-divider {
      height: 1px;
      background: var(--border);
      margin: 0.5rem 0;
    }

    /* Modal base styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.96);
      border-radius: var(--radius-lg);
      width: min(460px, 90%);
      padding: 1.9rem;
      box-shadow: var(--shadow-md);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.3rem;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 1.6rem;
      cursor: pointer;
      color: var(--muted);
      line-height: 1;
      padding: 0;
      width: 32px;
      height: 32px;
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    .modal-actions button {
      flex: 1;
      padding: 0.7rem 1.2rem;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      border: none;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-primary:hover {
      background: var(--accent-strong);
    }

    .btn-secondary {
      background: white;
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
      border: none;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--muted-strong);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      cursor: pointer;
    }

    .tree-item.empty-folder {
      opacity: 0.7;
    }

    .tree-item.empty-folder .icon {
      opacity: 0.6;
    }

    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s ease-in-out infinite;
      border-radius: 4px;
    }

    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .loading-row {
      display: flex;
      gap: 1rem;
      padding: 0.8rem 1rem;
      border-bottom: 1px solid var(--border);
    }

    .loading-row .skeleton {
      height: 20px;
    }

    /* File Type Icons */
    .file-icon {
      font-size: 1.2rem;
      margin-right: 0.5rem;
    }

    /* Drag & Drop Styles */
    .dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .drop-target {
      background: rgba(37, 99, 235, 0.15);
      border: 2px dashed var(--accent);
    }

    .tree-item[draggable="true"] {
      cursor: grab;
    }

    tbody tr[draggable="true"] {
      cursor: grab;
    }

    tbody tr.dragging {
      opacity: 0.5;
    }

    /* Selection Count Badge */
    .selection-badge {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--accent);
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: var(--radius-lg);
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.4);
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 50;
      animation: slideInUp 0.3s ease;
    }

    @keyframes slideInUp {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .selection-badge button {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 0.35rem 0.75rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.2s ease;
    }

    .selection-badge button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Enhanced Animations */
    .tree-item, tbody tr {
      transition: all 0.15s ease;
    }

    tbody tr:hover {
      transform: translateX(2px);
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      top: 5rem;
      right: 2rem;
      background: var(--surface);
      color: var(--text);
      padding: 1rem 1.25rem;
      border-radius: var(--radius-sm);
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.2);
      border-left: 4px solid var(--accent);
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      max-width: 400px;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }

    @media (max-width: 992px) {
      .shell {
        grid-template-columns: 1fr;
        padding: 1.2rem;
      }
      aside {
        display: none;
      }
      .workspace-head {
        padding: 1.1rem;
      }
      .workspace-actions {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      .workspace-actions button {
        width: 100%;
      }
      header {
        padding: 1rem 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="auth-overlay" id="auth-overlay">
    <div class="auth-card">
      <h2>Welcome to VeriCase Docs</h2>
      <p style="color: var(--muted); margin: 0;">Sign in to access your folders and documents. You can also paste an existing API token.</p>
      <input type="email" id="email" placeholder="Email address">
      <input type="password" id="pwd" placeholder="Password">
      <div style="display:flex; gap:0.6rem;">
        <button id="login" class="btn-primary" style="flex:1;">Log In</button>
        <button id="signup" class="btn-secondary" style="flex:1;">Sign Up</button>
      </div>
      <div>
        <button id="advancedToggle" class="link-button" type="button">Use an existing API token</button>
        <div id="advancedPanel" class="hidden" style="margin-top:0.75rem;">
          <label for="token" style="font-size:0.75rem; font-weight:600; color:var(--muted); text-transform:uppercase;">Token</label>
          <div style="display:flex; gap:0.5rem; margin-top:0.35rem;">
            <input type="text" id="token" placeholder="Bearer token">
            <button id="saveToken" class="btn-secondary">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <header>
    <div class="logo">
      <img src="assets/vericase-logo.png" alt="VeriCase" style="height:42px;">
      <div style="display:flex; flex-direction:column;">
        <strong>Williamrogers File Server</strong>
        <span style="color:var(--muted); font-size:0.85rem;">Shared ¬∑ Welbourne (WR)</span>
      </div>
    </div>
    <div class="session">
      <span id="session-email"></span>
      <button id="signout" class="btn-secondary btn-small">Sign Out</button>
    </div>
  </header>

  <div class="shell">
    <aside>
      <div class="nav-section">Navigation</div>
      <div class="nav-list">
        <button class="active">üìÅ Files</button>
        <button>üïò Recent</button>
        <button>‚≠ê Favorites</button>
        <button>üîó Links</button>
        <button>üóë Trash</button>
      </div>

      <div class="nav-section" style="padding-bottom:0;">Folders</div>
      <div class="tree-header">
        <span>Your Library</span>
        <div style="display:flex; gap:0.3rem;">
          <button id="new-folder-btn" title="New folder">+</button>
          <button id="tree-refresh" title="Refresh folders">‚ü≥</button>
        </div>
      </div>
      <div class="tree" id="path-tree"></div>
    </aside>

    <main>
      <div class="workspace-head">
        <div>
          <div class="crumbs" id="breadcrumbs"></div>
          <div>
            <h1 id="folder-title" style="margin:0.6rem 0 0.2rem;">All Documents</h1>
            <div id="library-status" class="muted"></div>
          </div>
        </div>
        <div class="workspace-actions">
          <button id="toolbar-upload" class="primary">+ Upload</button>
          <button id="toolbar-preview" disabled>Preview</button>
          <button id="toolbar-share" disabled>Share</button>
          <button id="toolbar-delete" disabled>Delete</button>
          <button id="library-reload">Reload</button>
          <div style="display:flex; gap:0.4rem; align-items:center;">
            <input type="search" id="library-search" placeholder="Search in this folder" style="width:200px;">
            <button id="library-search-btn">Search</button>
          </div>
        </div>
      </div>

      <div style="display:flex; gap:1rem; align-items:center;">
        <button id="library-prev" disabled>&larr; Prev</button>
        <span id="pagination-info" class="muted">Page 1</span>
        <button id="library-next" disabled>Next &rarr;</button>
      </div>

      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th style="width:40px;"> </th>
              <th>Item name</th>
              <th>Status</th>
              <th>Size</th>
              <th>Date uploaded</th>
              <th>Updated by</th>
              <th style="text-align:right;">Actions</th>
            </tr>
          </thead>
          <tbody id="doc-table-body"></tbody>
        </table>
        <div id="doc-table-empty">No documents in this folder yet.</div>
      </div>
    </main>
  </div>

  <div id="upload-modal" class="hidden" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(15,23,42,0.45); backdrop-filter:blur(8px);">
    <div style="background:rgba(255,255,255,0.96); border-radius:var(--radius-lg); width:min(460px, 100%); padding:1.9rem; display:flex; flex-direction:column; gap:1rem; box-shadow:var(--shadow-md);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Upload documents</h2>
        <button id="upload-close" style="border:none; background:transparent; font-size:1.6rem; cursor:pointer;">&times;</button>
      </div>
      <label for="path" style="font-size:0.75rem; font-weight:600; color:var(--muted); text-transform:uppercase;">Destination (optional)</label>
      <input type="text" id="path" placeholder="e.g., projects/acme/contracts">
      <div id="file-drop-area" style="border:2px dashed rgba(148,163,184,0.55); border-radius:var(--radius-lg); padding:2rem; text-align:center; cursor:pointer; background:rgba(248,250,252,0.8); transition:all 0.2s ease;">
        <input type="file" id="file" multiple style="display:none;">
        <p style="margin:0; color:var(--muted); font-weight:500;">Click to browse or drag and drop</p>
        <p id="file-name" style="margin-top:0.6rem; font-weight:600;"></p>
      </div>
      <button id="upload" class="btn-primary">Start upload</button>
      <div id="upout"></div>
    </div>
  </div>

  <div id="search-drawer" class="hidden" style="position:fixed; top:0; right:0; width:min(420px,100%); height:100%; background:var(--surface); border-left:1px solid var(--border); box-shadow:-12px 0 24px rgba(15,23,42,0.12); display:flex; flex-direction:column;">
    <div style="padding:1.2rem; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0;">Search results</h2>
      <button id="search-close" style="border:none; background:transparent; font-size:1.6rem; cursor:pointer;">&times;</button>
    </div>
    <div id="results" style="flex:1; overflow-y:auto; padding:1.2rem;"></div>
  </div>

  <!-- New Folder Modal -->
  <div id="new-folder-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Create New Folder</h2>
        <button class="modal-close" id="new-folder-close">&times;</button>
      </div>
      <div class="modal-body">
        <label for="new-folder-name">Folder Name</label>
        <input type="text" id="new-folder-name" placeholder="e.g., Projects or Legal/Contracts">
        <p style="color: var(--muted); font-size: 0.85rem; margin: 0.5rem 0 0;">
          Use / to create nested folders (e.g., "Projects/2024/Q1")
        </p>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" id="new-folder-cancel">Cancel</button>
        <button class="btn-primary" id="new-folder-create">Create Folder</button>
      </div>
    </div>
  </div>

  <!-- Rename Folder Modal -->
  <div id="rename-folder-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Rename Folder</h2>
        <button class="modal-close" id="rename-folder-close">&times;</button>
      </div>
      <div class="modal-body">
        <label for="rename-folder-path">Current Path</label>
        <input type="text" id="rename-folder-path" readonly style="background: var(--subsurface);">
        <label for="rename-folder-newname" style="margin-top: 1rem;">New Name</label>
        <input type="text" id="rename-folder-newname" placeholder="New folder name">
        <p style="color: var(--muted); font-size: 0.85rem; margin: 0.5rem 0 0;">
          All documents in this folder will be moved to the new path.
        </p>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" id="rename-folder-cancel">Cancel</button>
        <button class="btn-primary" id="rename-folder-save">Rename</button>
      </div>
    </div>
  </div>

  <!-- Delete Folder Modal -->
  <div id="delete-folder-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Delete Folder</h2>
        <button class="modal-close" id="delete-folder-close">&times;</button>
      </div>
      <div class="modal-body">
        <label for="delete-folder-path">Folder Path</label>
        <input type="text" id="delete-folder-path" readonly style="background: var(--subsurface);">
        <div class="checkbox-group" style="margin-top: 1rem;">
          <input type="checkbox" id="delete-folder-recursive">
          <label for="delete-folder-recursive" style="font-weight: 500; cursor: pointer;">
            Delete all documents in this folder
          </label>
        </div>
        <p style="color: var(--danger); font-size: 0.85rem; margin: 0.75rem 0 0;">
          ‚ö†Ô∏è This action cannot be undone. If recursive is checked, all documents and subfolders will be permanently deleted.
        </p>
      </div>
      <div class="modal-actions">
        <button class="btn-secondary" id="delete-folder-cancel">Cancel</button>
        <button class="btn-danger" id="delete-folder-confirm">Delete</button>
      </div>
    </div>
  </div>

  <!-- Context Menu -->
  <div id="context-menu" class="context-menu hidden">
    <div class="context-menu-item" id="ctx-new-folder">
      <span>üìÅ</span> New Folder
    </div>
    <div class="context-menu-item" id="ctx-rename-folder">
      <span>‚úèÔ∏è</span> Rename
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" id="ctx-delete-folder" style="color: var(--danger);">
      <span>üóë</span> Delete
    </div>
  </div>

  <!-- File Preview Modal -->
  <div id="preview-modal" class="modal-overlay hidden" style="z-index: 200;">
    <div style="position: relative; width: 95vw; height: 95vh; max-width: 1400px; background: var(--bg); border-radius: var(--radius-lg); overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
      <div style="position: absolute; top: 12px; right: 12px; z-index: 10;">
        <button id="preview-fullscreen" style="background: rgba(45,45,45,0.9); border: 1px solid var(--border); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-right: 8px;" title="Open in new tab">
          ‚õ∂ Full Screen
        </button>
        <button id="preview-close" style="background: rgba(45,45,45,0.9); border: 1px solid var(--border); color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;" title="Close preview">
          ‚úï Close
        </button>
      </div>
      <iframe id="preview-frame" style="width: 100%; height: 100%; border: none;"></iframe>
    </div>
  </div>

  <script>
    const appRoot = document.body;
    const base = window.location.origin.replace(/\/$/, '');

    const emailInput = document.getElementById('email');
    const pwdInput = document.getElementById('pwd');
    if (emailInput && !emailInput.value) emailInput.value = `user-${Date.now()}@example.com`;
    if (pwdInput && !pwdInput.value) pwdInput.value = 'StrongPass123!';

    const tokenInput = document.getElementById('token');
    const advancedToggle = document.getElementById('advancedToggle');
    const advancedPanel = document.getElementById('advancedPanel');
    const sessionEmail = document.getElementById('session-email');
    const signoutBtn = document.getElementById('signout');
    const treeContainer = document.getElementById('path-tree');
    const treeRefresh = document.getElementById('tree-refresh');
    const breadcrumbsEl = document.getElementById('breadcrumbs');
    const folderTitleEl = document.getElementById('folder-title');
    const libraryStatusEl = document.getElementById('library-status');
    const paginationInfo = document.getElementById('pagination-info');
    const docTableBody = document.getElementById('doc-table-body');
    const docTableEmpty = document.getElementById('doc-table-empty');

    const libraryPrev = document.getElementById('library-prev');
    const libraryNext = document.getElementById('library-next');
    const libraryReload = document.getElementById('library-reload');
    const toolbarUpload = document.getElementById('toolbar-upload');
    const toolbarPreview = document.getElementById('toolbar-preview');
    const toolbarShare = document.getElementById('toolbar-share');
    const toolbarDelete = document.getElementById('toolbar-delete');
    const searchDrawer = document.getElementById('search-drawer');
    const searchClose = document.getElementById('search-close');
    const searchInput = document.getElementById('library-search');
    const searchButton = document.getElementById('library-search-btn');

    const uploadModal = document.getElementById('upload-modal');
    const uploadClose = document.getElementById('upload-close');
    const fileDropArea = document.getElementById('file-drop-area');
    const fileInput = document.getElementById('file');
    const fileNameDisplay = document.getElementById('file-name');
    const uploadButton = document.getElementById('upload');
    const uploadOutput = document.getElementById('upout');
    const pathInput = document.getElementById('path');

    let token = localStorage.getItem('jwt') || '';
    let currentUserEmail = localStorage.getItem('userEmail') || '';
    let currentPath = '';
    let currentPage = 0;
    let totalDocuments = 0;
    const pageSize = 20;
    const selectedDocs = new Set();
    const expandedPaths = new Set(['']);
    let pathsCache = [];

    function expandAncestors(path) {
      if (!path) return;
      const parts = path.split('/').filter(Boolean);
      let prefix = '';
      parts.forEach(part => {
        prefix = prefix ? `${prefix}/${part}` : part;
        expandedPaths.add(prefix);
      });
    }

    function toggleTreePath(path) {
      if (!path) return;
      if (expandedPaths.has(path)) expandedPaths.delete(path);
      else expandedPaths.add(path);
      renderPaths(pathsCache);
    }

    function updateSessionEmail() {
      if (!sessionEmail) return;
      if (currentUserEmail) sessionEmail.textContent = currentUserEmail;
      else if (token) sessionEmail.textContent = 'Authenticated via token';
      else sessionEmail.textContent = '';
    }

    function renderBreadcrumbs(path) {
      if (!breadcrumbsEl) return;
      breadcrumbsEl.innerHTML = '';
      const segments = (path || '').split('/').filter(Boolean);
      const crumbs = [{ label: 'Shared', value: '' }];
      let prefix = '';
      segments.forEach(seg => {
        prefix = prefix ? prefix + '/' + seg : seg;
        crumbs.push({ label: seg, value: prefix });
      });
      crumbs.forEach((crumb, idx) => {
        const btn = document.createElement('button');
        btn.textContent = crumb.label || 'All documents';
        if (idx === crumbs.length - 1) {
          btn.disabled = true;
        } else {
          btn.addEventListener('click', () => {
            currentPage = 0;
            setActivePath(crumb.value);
            loadDocuments(true);
          });
        }
        breadcrumbsEl.appendChild(btn);
      });
    }

    function buildTree(paths) {
      const root = {};
      (paths || []).forEach(path => {
        if (!path) return;
        const parts = path.split('/').filter(Boolean);
        let node = root;
        let prefix = '';
        parts.forEach(part => {
          prefix = prefix ? prefix + '/' + part : part;
          if (!node[part]) node[part] = { path: prefix, children: {} };
          node = node[part].children;
        });
      });
      return root;
    }

    function createTreeNode(label, node, depth = 0) {
      const wrapper = document.createElement('div');
      const item = document.createElement('div');
      item.className = 'tree-item';
      item.dataset.path = node.path;
      item.style.paddingLeft = `${depth * 12 + 6}px`;

      const caret = document.createElement('span');
      caret.className = 'caret';

      const icon = document.createElement('span');
      icon.textContent = 'üìÅ';

      const text = document.createElement('span');
      text.textContent = label;

      const children = Object.keys(node.children).sort();
      const isExpanded = expandedPaths.has(node.path);

      if (children.length) {
        caret.textContent = isExpanded ? '‚ñæ' : '‚ñ∏';
        caret.addEventListener('click', (event) => {
          event.stopPropagation();
          toggleTreePath(node.path);
        });
      } else {
        caret.textContent = '‚ñ∏';
        caret.classList.add('invisible');
      }

      item.append(caret, icon, text);
      item.addEventListener('click', () => {
        currentPage = 0;
        setActivePath(node.path);
        loadDocuments(true);
      });

      // Drag & Drop for folders
      item.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        item.classList.add('drop-target');
      });

      item.addEventListener('dragleave', () => {
        item.classList.remove('drop-target');
      });

      item.addEventListener('drop', async (e) => {
        e.preventDefault();
        item.classList.remove('drop-target');
        const targetPath = node.path;
        
        try {
          const docIds = JSON.parse(e.dataTransfer.getData('text/plain'));
          if (docIds && docIds.length) {
            await moveDocumentsToFolder(docIds, targetPath);
          }
        } catch (err) {
          console.error('Drop failed:', err);
          showToast('Failed to move documents', 'error');
        }
      });

      wrapper.appendChild(item);

      if (children.length) {
        const container = document.createElement('div');
        container.style.marginLeft = '12px';
        container.style.display = isExpanded ? 'block' : 'none';
        children.forEach(child => {
          container.appendChild(createTreeNode(child, node.children[child], depth + 1));
        });
        wrapper.appendChild(container);
      }

      return wrapper;
    }

    // Move documents to folder
    async function moveDocumentsToFolder(docIds, targetPath) {
      if (!docIds || docIds.length === 0) return;
      
      try {
        const count = docIds.length;
        showToast(`Moving ${count} document${count > 1 ? 's' : ''}...`, 'success');
        
        // Move each document
        for (const docId of docIds) {
          const doc = visibleDocs.find(d => d.id === docId);
          if (!doc) continue;
          
          // Update document path via API
          await api(`/documents/${docId}`, 'PATCH', { path: targetPath });
        }
        
        showToast(`Moved ${count} document${count > 1 ? 's' : ''} to ${targetPath || 'root'}`, 'success');
        selectedDocs.clear();
        updateSelectionBadge();
        await loadPaths();
        await loadDocuments(true);
      } catch (err) {
        showToast(`Failed to move documents: ${err.message}`, 'error');
      }
    }

    function renderPaths(paths) {
      if (!treeContainer) return;
      pathsCache = Array.isArray(paths) ? paths.slice() : [];
      treeContainer.innerHTML = '';
      const all = document.createElement('div');
      all.className = 'tree-item';
      all.dataset.path = '';
      all.textContent = 'üóÇ All documents';
      all.addEventListener('click', () => {
        currentPage = 0;
        setActivePath('');
        loadDocuments(true);
      });
      treeContainer.appendChild(all);

      const tree = buildTree(pathsCache);
      expandAncestors(currentPath);
      Object.keys(tree).sort().forEach(name => {
        treeContainer.appendChild(createTreeNode(name, tree[name]));
      });

      setActivePath(currentPath || '');
    }

    function formatBytes(size) {
      if (!size || size <= 0) return '-';
      const units = ['B', 'KB', 'MB', 'GB'];
      let value = size;
      let unit = 0;
      while (value >= 1024 && unit < units.length - 1) {
        value /= 1024;
        unit += 1;
      }
      return `${value.toFixed(value < 10 ? 1 : 0)} ${units[unit]}`;
    }

    function setActivePath(path) {
      currentPath = path || '';
      expandedPaths.add('');
      expandAncestors(currentPath);
      if (folderTitleEl) folderTitleEl.textContent = currentPath ? currentPath.split('/').pop() : 'All Documents';
      renderBreadcrumbs(currentPath);
      if (treeContainer) {
        treeContainer.querySelectorAll('.tree-item').forEach(item => {
          item.classList.toggle('active', item.dataset.path === currentPath);
          const sibling = item.nextElementSibling;
          const caretEl = item.querySelector('.caret');
          if (sibling && sibling.children && sibling.children.length) {
            if (expandedPaths.has(item.dataset.path)) {
              sibling.style.display = 'block';
              if (caretEl && !caretEl.classList.contains('invisible')) caretEl.textContent = '‚ñæ';
            } else {
              sibling.style.display = 'none';
              if (caretEl && !caretEl.classList.contains('invisible')) caretEl.textContent = '‚ñ∏';
            }
          }
        });
      }
    }

    function updateToolbarState() {
      const hasSelection = selectedDocs.size > 0;
      if (toolbarPreview) toolbarPreview.disabled = !hasSelection;
      if (toolbarShare) toolbarShare.disabled = !hasSelection;
      if (toolbarDelete) toolbarDelete.disabled = !hasSelection;
    }

    // File type icons helper
    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const icons = {
        'pdf': 'üìÑ', 'doc': 'üìù', 'docx': 'üìù', 'txt': 'üìù',
        'xls': 'üìä', 'xlsx': 'üìä', 'csv': 'üìä',
        'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è',
        'mp4': 'üé¨', 'mov': 'üé¨', 'avi': 'üé¨',
        'zip': 'üì¶', 'rar': 'üì¶', '7z': 'üì¶'
      };
      return icons[ext] || 'üìé';
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Multi-select with Ctrl/Shift support
    let lastSelectedIndex = null;
    let visibleDocs = [];

    function renderDocumentRows(items) {
      if (!docTableBody) return;
      visibleDocs = items || [];
      const currentIds = new Set(visibleDocs.map(doc => doc.id));
      Array.from(selectedDocs).forEach(id => {
        if (!currentIds.has(id)) selectedDocs.delete(id);
      });
      updateToolbarState();
      updateSelectionBadge();

      docTableBody.innerHTML = '';
      if (!items || items.length === 0) {
        docTableEmpty.style.display = 'block';
        return;
      }
      docTableEmpty.style.display = 'none';

      items.forEach((doc, index) => {
        const tr = document.createElement('tr');
        tr.dataset.id = doc.id;
        tr.dataset.index = index;
        tr.draggable = true;

        const selectTd = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'row-select';
        if (selectedDocs.has(doc.id)) {
          checkbox.checked = true;
          tr.classList.add('selected');
        }
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            selectedDocs.add(doc.id);
            tr.classList.add('selected');
          } else {
            selectedDocs.delete(doc.id);
            tr.classList.remove('selected');
          }
          updateToolbarState();
          updateSelectionBadge();
        });
        selectTd.appendChild(checkbox);
        tr.appendChild(selectTd);

        const nameTd = document.createElement('td');
        const icon = document.createElement('span');
        icon.className = 'file-icon';
        icon.textContent = getFileIcon(doc.filename);
        nameTd.appendChild(icon);
        nameTd.appendChild(document.createTextNode(doc.filename));
        tr.appendChild(nameTd);

        const statusTd = document.createElement('td');
        statusTd.textContent = doc.status || '-';
        tr.appendChild(statusTd);

        const sizeTd = document.createElement('td');
        sizeTd.textContent = formatBytes(doc.size);
        tr.appendChild(sizeTd);

        const createdTd = document.createElement('td');
        createdTd.textContent = doc.created_at ? new Date(doc.created_at).toLocaleString() : '‚Äî';
        tr.appendChild(createdTd);

        const updatedByTd = document.createElement('td');
        updatedByTd.textContent = currentUserEmail || 'You';
        tr.appendChild(updatedByTd);

        const actionsTd = document.createElement('td');
        actionsTd.style.textAlign = 'right';
        actionsTd.innerHTML = `
          <button class="action-preview" data-id="${doc.id}">Preview</button>
          <button class="action-share" data-id="${doc.id}">Share</button>
          <button class="action-delete" data-id="${doc.id}">Delete</button>
        `;
        tr.appendChild(actionsTd);

        // Multi-select with Ctrl/Shift
        tr.addEventListener('click', (event) => {
          if (event.target.tagName === 'BUTTON' || event.target.type === 'checkbox') return;
          
          if (event.ctrlKey || event.metaKey) {
            // Ctrl+Click: Toggle selection
            if (selectedDocs.has(doc.id)) {
              selectedDocs.delete(doc.id);
              checkbox.checked = false;
              tr.classList.remove('selected');
            } else {
              selectedDocs.add(doc.id);
              checkbox.checked = true;
              tr.classList.add('selected');
            }
            lastSelectedIndex = index;
          } else if (event.shiftKey && lastSelectedIndex !== null) {
            // Shift+Click: Range selection
            const start = Math.min(lastSelectedIndex, index);
            const end = Math.max(lastSelectedIndex, index);
            for (let i = start; i <= end; i++) {
              const docId = visibleDocs[i].id;
              selectedDocs.add(docId);
              const row = docTableBody.querySelector(`tr[data-index="${i}"]`);
              if (row) {
                row.classList.add('selected');
                const cb = row.querySelector('.row-select');
                if (cb) cb.checked = true;
              }
            }
          } else {
            // Regular click: Single selection
            selectedDocs.clear();
            document.querySelectorAll('tr.selected').forEach(r => {
              r.classList.remove('selected');
              const cb = r.querySelector('.row-select');
              if (cb) cb.checked = false;
            });
            selectedDocs.add(doc.id);
            checkbox.checked = true;
            tr.classList.add('selected');
            lastSelectedIndex = index;
          }
          updateToolbarState();
          updateSelectionBadge();
        });

        tr.addEventListener('dblclick', () => handlePreview(doc.id));

        // Drag & Drop
        tr.addEventListener('dragstart', (e) => {
          if (!selectedDocs.has(doc.id)) {
            selectedDocs.clear();
            selectedDocs.add(doc.id);
            updateToolbarState();
            updateSelectionBadge();
          }
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', JSON.stringify(Array.from(selectedDocs)));
          tr.classList.add('dragging');
        });

        tr.addEventListener('dragend', () => {
          tr.classList.remove('dragging');
        });

        docTableBody.appendChild(tr);
      });

      attachRowActions();
    }

    // Selection badge
    function updateSelectionBadge() {
      let badge = document.getElementById('selection-badge');
      
      if (selectedDocs.size > 0) {
        if (!badge) {
          badge = document.createElement('div');
          badge.id = 'selection-badge';
          badge.className = 'selection-badge';
          document.body.appendChild(badge);
        }
        badge.innerHTML = `
          <span>${selectedDocs.size} selected</span>
          <button onclick="clearSelection()">Clear</button>
        `;
      } else if (badge) {
        badge.remove();
      }
    }

    window.clearSelection = function() {
      selectedDocs.clear();
      document.querySelectorAll('tr.selected').forEach(tr => {
        tr.classList.remove('selected');
        const cb = tr.querySelector('.row-select');
        if (cb) cb.checked = false;
      });
      updateToolbarState();
      updateSelectionBadge();
    };

    function showStatus(id, message, type) {
      const container = document.getElementById(id);
      if (!container) return;
      container.innerHTML = `<div class="status-card status-${type || 'info'}">${message}</div>`;
    }

    async function api(path, method = 'GET', body = null) {
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);
      const response = await fetch(base + path, options);
      if (!response.ok) {
        const text = await response.text();
        throw new Error(`API Error: ${response.status} ${response.statusText} - ${text}`);
      }
      if (response.status === 204) return null;
      return response.json();
    }

    async function loadDocuments(reset = false) {
      if (!token || !docTableBody) return;
      if (reset) {
        currentPage = 0;
        selectedDocs.clear();
        updateToolbarState();
      }
      if (libraryStatusEl) libraryStatusEl.textContent = 'Loading documents...';
      const params = new URLSearchParams();
      params.set('limit', pageSize);
      params.set('offset', currentPage * pageSize);
      if (currentPath) params.set('path_prefix', currentPath);
      try {
        const res = await api('/documents?' + params.toString());
        totalDocuments = res.total || 0;
        if (libraryStatusEl) {
          const start = totalDocuments ? currentPage * pageSize + 1 : 0;
          const end = Math.min(totalDocuments, (currentPage + 1) * pageSize);
          libraryStatusEl.textContent = totalDocuments
            ? `${totalDocuments} documents ‚Ä¢ showing ${start}-${end}`
            : 'No documents yet.';
        }
        if (paginationInfo) {
          const totalPages = totalDocuments ? Math.ceil(totalDocuments / pageSize) : 1;
          paginationInfo.textContent = `Page ${totalDocuments ? currentPage + 1 : 0} of ${totalPages}`;
        }
        if (libraryPrev) libraryPrev.disabled = currentPage === 0;
        if (libraryNext) libraryNext.disabled = (currentPage + 1) * pageSize >= totalDocuments;
        renderDocumentRows(res.items || []);
      } catch (err) {
        if (libraryStatusEl) libraryStatusEl.textContent = 'Unable to load documents.';
      }
    }

    async function loadPaths() {
      if (!token || !treeContainer) return;
      try {
        const res = await api('/documents/paths');
        renderPaths(res.paths || []);
      } catch (err) {
        console.warn('Unable to load paths', err);
      }
    }

    function enterAuthenticatedView(scroll = true) {
      if (!token) return;
      appRoot.classList.add('authed');
      updateSessionEmail();
      if (advancedPanel && !advancedPanel.classList.contains('hidden')) advancedPanel.classList.add('hidden');
      loadPaths();
      loadDocuments(true);
      if (scroll) window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function leaveAuthenticatedView(message) {
      token = '';
      currentUserEmail = '';
      localStorage.removeItem('jwt');
      localStorage.removeItem('userEmail');
      if (tokenInput) tokenInput.value = '';
      appRoot.classList.remove('authed');
      currentPath = '';
      currentPage = 0;
      totalDocuments = 0;
      selectedDocs.clear();
      expandedPaths.clear();
      expandedPaths.add('');
      pathsCache = [];
      updateToolbarState();
      if (docTableBody) docTableBody.innerHTML = '';
      docTableEmpty.style.display = 'none';
      if (libraryStatusEl) libraryStatusEl.textContent = '';
      if (paginationInfo) paginationInfo.textContent = 'Page 1';
      renderBreadcrumbs('');
      if (treeContainer) treeContainer.innerHTML = '';
      updateSessionEmail();
      if (message) alert(message);
    }

    function attachRowActions() {
      document.querySelectorAll('.action-preview').forEach(btn => {
        btn.addEventListener('click', () => handlePreview(btn.dataset.id));
      });
      document.querySelectorAll('.action-share').forEach(btn => {
        btn.addEventListener('click', () => handleShare(btn.dataset.id));
      });
      document.querySelectorAll('.action-delete').forEach(btn => {
        btn.addEventListener('click', () => handleDelete(btn.dataset.id));
      });
    }

    function handlePreview(id) {
      if (!id) { alert('Select a document first.'); return; }
      const doc = visibleDocs.find(d => d.id === id);
      if (!doc) { alert('Document not found.'); return; }
      
      api('/documents/' + id + '/signed_url')
        .then(r => {
          const url = `file-viewer.html?file=${encodeURIComponent(r.url)}&filename=${encodeURIComponent(r.filename)}&type=${encodeURIComponent(r.content_type || '')}`;
          openPreviewModal(url);
        })
        .catch(err => alert(err.message));
    }

    function openPreviewModal(url) {
      const modal = document.getElementById('preview-modal');
      const frame = document.getElementById('preview-frame');
      const fullscreenBtn = document.getElementById('preview-fullscreen');
      const closeBtn = document.getElementById('preview-close');
      
      frame.src = url;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      fullscreenBtn.onclick = () => window.open(url, '_blank');
      closeBtn.onclick = closePreviewModal;
    }

    function closePreviewModal() {
      const modal = document.getElementById('preview-modal');
      const frame = document.getElementById('preview-frame');
      
      modal.classList.add('hidden');
      frame.src = '';
      document.body.style.overflow = '';
    }

    // Close preview when clicking outside - set up after DOM is ready
    const previewModal = document.getElementById('preview-modal');
    if (previewModal) {
      previewModal.addEventListener('click', (e) => {
        if (e.target.id === 'preview-modal') {
          closePreviewModal();
        }
      });
    }

    function handleShare(id) {
      if (!id) { alert('Select a document first.'); return; }
      const password = prompt('Optional password for share (blank for none):');
      if (password === null) return;
      const payload = { document_id: id };
      if (password.trim()) payload.password = password.trim();
      api('/shares', 'POST', payload)
        .then(res => {
          const url = `${window.location.origin}/ui/public-viewer.html?token=${res.token}`;
          alert(`Share link:\n${url}\n\nPassword required: ${res.requires_password ? 'Yes' : 'No'}`);
        })
        .catch(err => alert(err.message));
    }

    function handleDelete(id) {
      if (!id) { alert('Select a document first.'); return; }
      if (!confirm('Delete this document? This cannot be undone.')) return;
      api('/documents/' + id, 'DELETE')
        .then(() => loadDocuments(true))
        .catch(err => alert(err.message));
    }

    function primarySelection() {
      return selectedDocs.values().next().value;
    }

    if (libraryPrev) {
      libraryPrev.addEventListener('click', () => {
        if (currentPage > 0) {
          currentPage -= 1;
          loadDocuments();
        }
      });
    }
    if (libraryNext) {
      libraryNext.addEventListener('click', () => {
        const maxItems = (currentPage + 1) * pageSize;
        if (maxItems < totalDocuments) {
          currentPage += 1;
          loadDocuments();
        }
      });
    }
    if (libraryReload) {
      libraryReload.addEventListener('click', () => {
        loadPaths();
        loadDocuments(true);
      });
    }
    if (treeRefresh) {
      treeRefresh.addEventListener('click', () => loadPaths());
    }

    document.getElementById('saveToken').addEventListener('click', () => {
      const rawToken = tokenInput ? tokenInput.value.trim() : '';
      if (!rawToken) {
        leaveAuthenticatedView('Token cleared.');
        return;
      }
      token = rawToken;
      currentUserEmail = '';
      localStorage.setItem('jwt', token);
      localStorage.removeItem('userEmail');
      alert('Token saved. Loading workspace...');
      enterAuthenticatedView();
    });

    document.getElementById('signup').addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const pwd = pwdInput.value.trim();
      if (!email || !pwd) { alert('Provide email and password.'); return; }
      try {
        const res = await api('/auth/signup','POST',{ email, password: pwd });
        token = res.token;
        currentUserEmail = (res && res.user && res.user.email) ? res.user.email : email;
        localStorage.setItem('jwt', token);
        localStorage.setItem('userEmail', currentUserEmail);
        if (tokenInput) tokenInput.value = token;
        alert('Signed up. Loading workspace...');
        enterAuthenticatedView();
      } catch (err) {
        alert(err.message);
      }
    });

    document.getElementById('login').addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const pwd = pwdInput.value.trim();
      if (!email || !pwd) { alert('Provide email and password.'); return; }
      try {
        const res = await api('/auth/login','POST',{ email, password: pwd });
        token = res.token;
        currentUserEmail = (res && res.user && res.user.email) ? res.user.email : email;
        localStorage.setItem('jwt', token);
        localStorage.setItem('userEmail', currentUserEmail);
        if (tokenInput) tokenInput.value = token;
        alert('Logged in. Loading workspace...');

        enterAuthenticatedView();
      } catch (err) {
        alert(err.message);
      }
    });

    if (advancedToggle && advancedPanel) {
      advancedToggle.addEventListener('click', () => {
        const hidden = advancedPanel.classList.toggle('hidden');
        advancedToggle.textContent = hidden ? 'Use an existing API token' : 'Hide token input';
        if (!hidden && tokenInput && token) tokenInput.value = token;
      });
    }

    if (signoutBtn) {
      signoutBtn.addEventListener('click', () => leaveAuthenticatedView('Signed out.'));
    }

    if (toolbarUpload) toolbarUpload.addEventListener('click', () => token ? uploadModal.classList.remove('hidden') : alert('Sign in first.'));
    if (uploadClose) uploadClose.addEventListener('click', () => uploadModal.classList.add('hidden'));

    if (toolbarPreview) toolbarPreview.addEventListener('click', () => handlePreview(primarySelection()));
    if (toolbarShare) toolbarShare.addEventListener('click', () => handleShare(primarySelection()));
    if (toolbarDelete) toolbarDelete.addEventListener('click', () => handleDelete(primarySelection()));

    function openSearchDrawer() { searchDrawer.classList.remove('hidden'); }
    function closeSearchDrawer() {
      searchDrawer.classList.add('hidden');
      const resultsEl = document.getElementById('results');
      if (resultsEl) resultsEl.innerHTML = '';
    }
    if (searchClose) searchClose.addEventListener('click', closeSearchDrawer);

    // Search debouncing
    let searchDebounceTimer;
    const performSearch = async () => {
      if (!token) { alert('Sign in to search.'); return; }
      const q = searchInput.value.trim();
      if (!q) return;
      
      openSearchDrawer();
      const resultsEl = document.getElementById('results');
      if (resultsEl) resultsEl.innerHTML = '<p class="muted"><span class="spinner"></span> Searching...</p>';
      
      try {
        const params = new URLSearchParams({ q });
        if (currentPath) params.set('path_prefix', currentPath);
        const res = await api('/search?' + params.toString());
        if (!resultsEl) return;
        
        resultsEl.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <div class="muted">${res.count} results found</div>
            ${res.count > 0 ? `<button class="btn-secondary btn-small" onclick="closeSearchDrawer()" style="padding:0.3rem 0.7rem;">Close</button>` : ''}
          </div>
        `;
        
        if (res.hits.length === 0) {
          resultsEl.innerHTML += '<div class="muted" style="margin-top:0.75rem;">No documents matched your query.</div>';
        }
        
        res.hits.forEach(hit => {
          const card = document.createElement('div');
          card.style.border = '1px solid var(--border)';
          card.style.borderRadius = '10px';
          card.style.padding = '0.9rem';
          card.style.marginTop = '0.85rem';
          card.style.cursor = 'pointer';
          card.style.transition = 'all 0.2s ease';
          card.addEventListener('mouseenter', () => {
            card.style.background = 'var(--subsurface)';
            card.style.borderColor = 'var(--accent)';
          });
          card.addEventListener('mouseleave', () => {
            card.style.background = 'white';
            card.style.borderColor = 'var(--border)';
          });
          
          const fileIcon = getFileIcon(hit.filename);
          card.innerHTML = `
            <div style="display:flex; align-items:center; gap:0.5rem;">
              <span style="font-size:1.2rem;">${fileIcon}</span>
              <strong>${hit.title || hit.filename}</strong>
            </div>
            ${hit.path ? `<div class="muted" style="margin-top:0.3rem;">üìÅ ${hit.path}</div>` : ''}
            <div class="muted" style="margin-top:0.4rem;">${hit.snippet || 'No snippet available.'}</div>
            <div style="margin-top:0.6rem; display:flex; gap:0.5rem;">
              <button class="action-preview" data-id="${hit.id}">Preview</button>
              <button class="action-share" data-id="${hit.id}">Share</button>
            </div>
          `;
          resultsEl.appendChild(card);
        });
        attachRowActions();
      } catch (err) {
        if (resultsEl) resultsEl.innerHTML = `<div class="muted">Search failed: ${err.message}</div>`;
      }
    };

    if (searchButton) {
      searchButton.addEventListener('click', () => {
        clearTimeout(searchDebounceTimer);
        performSearch();
      });
    }

    if (searchInput) {
      // Debounced live search
      searchInput.addEventListener('input', () => {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = setTimeout(performSearch, 500);
      });

      searchInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          clearTimeout(searchDebounceTimer);
          performSearch();
        } else if (e.key === 'Escape') {
          closeSearchDrawer();
          searchInput.blur();
        }
      });
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl+F or Cmd+F: Focus search
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        if (searchInput) searchInput.focus();
      }
      
      // Escape: Close preview modal first, then clear selection
      if (e.key === 'Escape') {
        const previewModal = document.getElementById('preview-modal');
        if (previewModal && !previewModal.classList.contains('hidden')) {
          e.preventDefault();
          closePreviewModal();
          return;
        }
        if (selectedDocs.size > 0) {
          clearSelection();
        }
      }
      
      // Ctrl+A or Cmd+A: Select all visible documents
      if ((e.ctrlKey || e.metaKey) && e.key === 'a' && document.activeElement.tagName !== 'INPUT') {
        e.preventDefault();
        visibleDocs.forEach(doc => selectedDocs.add(doc.id));
        document.querySelectorAll('#doc-table-body tr').forEach(tr => {
          tr.classList.add('selected');
          const cb = tr.querySelector('.row-select');
          if (cb) cb.checked = true;
        });
        updateToolbarState();
        updateSelectionBadge();
      }
    });

    function addUploadStatus(file) {
      if (!uploadOutput) return null;
      const wrapper = document.createElement('div');
      wrapper.className = 'upload-status';
      const nameEl = document.createElement('strong');
      nameEl.textContent = file.name;
      const statusEl = document.createElement('span');
      statusEl.textContent = 'Queued';
      wrapper.append(nameEl, statusEl);
      uploadOutput.appendChild(wrapper);
      return statusEl;
    }

    async function uploadSingleFile(file, path) {
      const statusEl = addUploadStatus(file);
      const update = (message, state) => {
        if (!statusEl) return;
        statusEl.textContent = message;
        statusEl.classList.remove('success', 'error');
        if (state) statusEl.classList.add(state);
      };
      try {
        update('Preparing upload...');
        const presign = await api('/uploads/presign','POST',{ filename: file.name, content_type: file.type || 'application/octet-stream', path });
        update('Uploading to storage...');
        const put = await fetch(presign.url, { method:'PUT', headers:{ 'Content-Type': file.type || 'application/octet-stream' }, body: file });
        if (!put.ok) throw new Error(await put.text());
        update('Finalizing upload...');
        await api('/uploads/complete','POST',{ key: presign.key, filename: file.name, content_type: file.type || 'application/octet-stream', size: file.size, path });
        update('Uploaded ‚Ä¢ processing', 'success');
        return true;
      } catch (err) {
        update(`Failed: ${err.message}`, 'error');
        throw err;
      }
    }

    function describeFileSelection(list) {
      if (!list || !list.length) return '';
      if (list.length === 1) return `Selected: ${list[0].name}`;
      return `${list.length} files selected`;
    }

    function updateFileSelectionDisplay(files) {
      if (fileNameDisplay) {
        fileNameDisplay.textContent = describeFileSelection(files);
      }
    }

    if (fileDropArea) {
      fileDropArea.addEventListener('click', () => { if (fileInput) fileInput.click(); });
      fileDropArea.addEventListener('dragover', e => e.preventDefault());
      fileDropArea.addEventListener('drop', e => {
        e.preventDefault();
        if (fileInput && e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) {
          const dt = new DataTransfer();
          Array.from(e.dataTransfer.files).forEach(file => dt.items.add(file));
          fileInput.files = dt.files;
          updateFileSelectionDisplay(Array.from(dt.files));
        }
      });
    }
    if (fileInput) {
      fileInput.addEventListener('change', () => {
        updateFileSelectionDisplay(Array.from(fileInput.files));
      });
    }
    if (uploadButton) {
      uploadButton.addEventListener('click', async () => {
        if (!token) { alert('Sign in first.'); return; }
        if (!fileInput || !fileInput.files.length) { alert('Select one or more files to upload.'); return; }
        const files = Array.from(fileInput.files);
        const path = pathInput.value.trim();
        if (uploadOutput) uploadOutput.innerHTML = '';
        uploadButton.disabled = true;
        const originalLabel = uploadButton.textContent;
        uploadButton.textContent = 'Uploading...';

        const results = await Promise.allSettled(files.map(file => uploadSingleFile(file, path)));

        uploadButton.disabled = false;
        uploadButton.textContent = originalLabel;

        const anySuccess = results.some(r => r.status === 'fulfilled');
        const anyFailure = results.some(r => r.status === 'rejected');

        if (anySuccess) {
          loadDocuments(true);
        }
        if (!anyFailure) {
          uploadModal.classList.add('hidden');
          fileInput.value = '';
          fileNameDisplay.textContent = '';
        }
      });
    }

    updateSessionEmail();
    if (token) {
      if (tokenInput) tokenInput.value = token;
      enterAuthenticatedView(false);
    } else {
      appRoot.classList.remove('authed');
    }

    // ===== FOLDER MANAGEMENT =====

    const newFolderModal = document.getElementById('new-folder-modal');
    const newFolderBtn = document.getElementById('new-folder-btn');
    const newFolderClose = document.getElementById('new-folder-close');
    const newFolderCancel = document.getElementById('new-folder-cancel');
    const newFolderCreate = document.getElementById('new-folder-create');
    const newFolderNameInput = document.getElementById('new-folder-name');

    const renameFolderModal = document.getElementById('rename-folder-modal');
    const renameFolderClose = document.getElementById('rename-folder-close');
    const renameFolderCancel = document.getElementById('rename-folder-cancel');
    const renameFolderSave = document.getElementById('rename-folder-save');
    const renameFolderPathInput = document.getElementById('rename-folder-path');
    const renameFolderNewnameInput = document.getElementById('rename-folder-newname');

    const deleteFolderModal = document.getElementById('delete-folder-modal');
    const deleteFolderClose = document.getElementById('delete-folder-close');
    const deleteFolderCancel = document.getElementById('delete-folder-cancel');
    const deleteFolderConfirm = document.getElementById('delete-folder-confirm');
    const deleteFolderPathInput = document.getElementById('delete-folder-path');
    const deleteFolderRecursive = document.getElementById('delete-folder-recursive');

    const contextMenu = document.getElementById('context-menu');
    const ctxNewFolder = document.getElementById('ctx-new-folder');
    const ctxRenameFolder = document.getElementById('ctx-rename-folder');
    const ctxDeleteFolder = document.getElementById('ctx-delete-folder');

    let contextMenuTargetPath = '';

    // Open new folder modal
    function openNewFolderModal(prefillPath = '') {
      if (!token) { alert('Sign in first.'); return; }
      if (newFolderNameInput) newFolderNameInput.value = prefillPath;
      if (newFolderModal) newFolderModal.classList.remove('hidden');
      if (newFolderNameInput) newFolderNameInput.focus();
    }

    // Close new folder modal
    function closeNewFolderModal() {
      if (newFolderModal) newFolderModal.classList.add('hidden');
      if (newFolderNameInput) newFolderNameInput.value = '';
    }

    // Create folder
    async function createFolder() {
      if (!token) { alert('Sign in first.'); return; }
      const path = newFolderNameInput ? newFolderNameInput.value.trim() : '';
      if (!path) { alert('Enter a folder name.'); return; }
      
      try {
        await api('/folders', 'POST', { path });
        alert(`Folder "${path}" created successfully.`);
        closeNewFolderModal();
        await loadPaths();
        // Navigate to the new folder
        setActivePath(path);
        await loadDocuments(true);
      } catch (err) {
        alert(`Failed to create folder: ${err.message}`);
      }
    }

    // Open rename folder modal
    function openRenameFolderModal(folderPath) {
      if (!token) { alert('Sign in first.'); return; }
      if (!folderPath) { alert('Select a folder to rename.'); return; }
      
      if (renameFolderPathInput) renameFolderPathInput.value = folderPath;
      if (renameFolderNewnameInput) {
        const lastSegment = folderPath.split('/').pop();
        renameFolderNewnameInput.value = lastSegment;
      }
      if (renameFolderModal) renameFolderModal.classList.remove('hidden');
      if (renameFolderNewnameInput) renameFolderNewnameInput.focus();
    }

    // Close rename folder modal
    function closeRenameFolderModal() {
      if (renameFolderModal) renameFolderModal.classList.add('hidden');
      if (renameFolderPathInput) renameFolderPathInput.value = '';
      if (renameFolderNewnameInput) renameFolderNewnameInput.value = '';
    }

    // Rename folder
    async function renameFolder() {
      if (!token) { alert('Sign in first.'); return; }
      const oldPath = renameFolderPathInput ? renameFolderPathInput.value.trim() : '';
      const newName = renameFolderNewnameInput ? renameFolderNewnameInput.value.trim() : '';
      
      if (!oldPath || !newName) { alert('Provide both paths.'); return; }
      
      // Build new path
      const parts = oldPath.split('/');
      parts[parts.length - 1] = newName;
      const newPath = parts.join('/');
      
      if (oldPath === newPath) {
        alert('New name is the same as the old name.');
        return;
      }
      
      try {
        const result = await api('/folders', 'PATCH', { old_path: oldPath, new_path: newPath });
        alert(`Folder renamed successfully. ${result.documents_updated} documents updated.`);
        closeRenameFolderModal();
        await loadPaths();
        // Navigate to the renamed folder
        setActivePath(newPath);
        await loadDocuments(true);
      } catch (err) {
        alert(`Failed to rename folder: ${err.message}`);
      }
    }

    // Open delete folder modal
    function openDeleteFolderModal(folderPath) {
      if (!token) { alert('Sign in first.'); return; }
      if (!folderPath) { alert('Select a folder to delete.'); return; }
      
      if (deleteFolderPathInput) deleteFolderPathInput.value = folderPath;
      if (deleteFolderRecursive) deleteFolderRecursive.checked = false;
      if (deleteFolderModal) deleteFolderModal.classList.remove('hidden');
    }

    // Close delete folder modal
    function closeDeleteFolderModal() {
      if (deleteFolderModal) deleteFolderModal.classList.add('hidden');
      if (deleteFolderPathInput) deleteFolderPathInput.value = '';
      if (deleteFolderRecursive) deleteFolderRecursive.checked = false;
    }

    // Delete folder
    async function deleteFolder() {
      if (!token) { alert('Sign in first.'); return; }
      const path = deleteFolderPathInput ? deleteFolderPathInput.value.trim() : '';
      const recursive = deleteFolderRecursive ? deleteFolderRecursive.checked : false;
      
      if (!path) { alert('No folder selected.'); return; }
      
      const confirmMsg = recursive 
        ? `Are you sure you want to delete "${path}" and ALL its contents? This cannot be undone.`
        : `Are you sure you want to delete the empty folder "${path}"?`;
      
      if (!confirm(confirmMsg)) return;
      
      try {
        const params = new URLSearchParams({ path });
        if (recursive) params.set('recursive', 'true');
        const result = await api('/folders?' + params.toString(), 'DELETE');
        
        const msg = recursive 
          ? `Folder deleted. ${result.documents_deleted} documents and ${result.folders_deleted} folders removed.`
          : 'Empty folder deleted successfully.';
        alert(msg);
        
        closeDeleteFolderModal();
        await loadPaths();
        // Navigate to parent folder or root
        const parentPath = path.split('/').slice(0, -1).join('/');
        setActivePath(parentPath);
        await loadDocuments(true);
      } catch (err) {
        alert(`Failed to delete folder: ${err.message}`);
      }
    }

    // Context menu handlers
    function showContextMenu(x, y, folderPath) {
      contextMenuTargetPath = folderPath;
      if (contextMenu) {
        contextMenu.style.left = `${x}px`;
        contextMenu.style.top = `${y}px`;
        contextMenu.classList.remove('hidden');
      }
    }

    function hideContextMenu() {
      if (contextMenu) contextMenu.classList.add('hidden');
      contextMenuTargetPath = '';
    }

    // Event listeners for modals
    if (newFolderBtn) newFolderBtn.addEventListener('click', () => openNewFolderModal(currentPath));
    if (newFolderClose) newFolderClose.addEventListener('click', closeNewFolderModal);
    if (newFolderCancel) newFolderCancel.addEventListener('click', closeNewFolderModal);
    if (newFolderCreate) newFolderCreate.addEventListener('click', createFolder);
    if (newFolderNameInput) {
      newFolderNameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          createFolder();
        }
      });
    }

    if (renameFolderClose) renameFolderClose.addEventListener('click', closeRenameFolderModal);
    if (renameFolderCancel) renameFolderCancel.addEventListener('click', closeRenameFolderModal);
    if (renameFolderSave) renameFolderSave.addEventListener('click', renameFolder);
    if (renameFolderNewnameInput) {
      renameFolderNewnameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          renameFolder();
        }
      });
    }

    if (deleteFolderClose) deleteFolderClose.addEventListener('click', closeDeleteFolderModal);
    if (deleteFolderCancel) deleteFolderCancel.addEventListener('click', closeDeleteFolderModal);
    if (deleteFolderConfirm) deleteFolderConfirm.addEventListener('click', deleteFolder);

    // Context menu event listeners
    if (ctxNewFolder) ctxNewFolder.addEventListener('click', () => {
      hideContextMenu();
      openNewFolderModal(contextMenuTargetPath ? contextMenuTargetPath + '/' : '');
    });
    if (ctxRenameFolder) ctxRenameFolder.addEventListener('click', () => {
      hideContextMenu();
      openRenameFolderModal(contextMenuTargetPath);
    });
    if (ctxDeleteFolder) ctxDeleteFolder.addEventListener('click', () => {
      hideContextMenu();
      openDeleteFolderModal(contextMenuTargetPath);
    });

    // Close context menu when clicking outside
    document.addEventListener('click', (e) => {
      if (contextMenu && !contextMenu.contains(e.target)) {
        hideContextMenu();
      }
    });

    // Add right-click support to tree items
    document.addEventListener('contextmenu', (e) => {
      const treeItem = e.target.closest('.tree-item');
      if (treeItem && treeItem.dataset.path !== undefined) {
        e.preventDefault();
        const folderPath = treeItem.dataset.path;
        // Don't show context menu for root "All documents"
        if (folderPath === '' && treeItem.textContent.includes('All documents')) return;
        showContextMenu(e.pageX, e.pageY, folderPath);
      }
    });

    // Close modals when clicking on overlay
    if (newFolderModal) {
      newFolderModal.addEventListener('click', (e) => {
        if (e.target === newFolderModal) closeNewFolderModal();
      });
    }
    if (renameFolderModal) {
      renameFolderModal.addEventListener('click', (e) => {
        if (e.target === renameFolderModal) closeRenameFolderModal();
      });
    }
    if (deleteFolderModal) {
      deleteFolderModal.addEventListener('click', (e) => {
        if (e.target === deleteFolderModal) closeDeleteFolderModal();
      });
    }
  </script>
</body>
</html>
