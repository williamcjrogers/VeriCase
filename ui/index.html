<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VeriCase Docs Workspace</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f6fb;
      --surface: #ffffff;
      --subsurface: #f8fafc;
      --text: #111827;
      --muted: #64748b;
      --muted-strong: #475569;
      --border: #e2e8f0;
      --accent: #2563eb;
      --accent-strong: #1d4ed8;
      --accent-soft: rgba(37, 99, 235, 0.12);
      --danger: #ef4444;
      --success: #10b981;
      --shadow-sm: 0 2px 6px rgba(15, 23, 42, 0.08);
      --shadow-md: 0 16px 32px rgba(15, 23, 42, 0.1);
      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 20px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #edf2fb 0%, #f8fafc 45%, #eef2ff 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    header .session {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    header .logo strong {
      font-size: 1.1rem;
      letter-spacing: -0.01em;
    }

    header .logo span {
      color: var(--muted);
      font-size: 0.8rem;
    }

    header .session {
      gap: 1rem;
    }

    header .session span {
      color: var(--muted);
      font-size: 0.85rem;
      letter-spacing: 0.02em;
    }

    header .session button {
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(255, 255, 255, 0.85);
      padding: 0.45rem 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    header .session button:hover {
      border-color: rgba(37, 99, 235, 0.35);
      color: var(--accent);
    }

    .shell {
      flex: 1;
      display: grid;
      grid-template-columns: clamp(220px, 18vw, 280px) 1fr;
      min-height: 0;
      padding: 1.5rem 2rem 2rem;
      gap: 1.5rem;
    }

    aside {
      border-right: 1px solid rgba(148, 163, 184, 0.18);
      background: rgba(255, 255, 255, 0.85);
      display: flex;
      flex-direction: column;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      min-height: 0;
    }

    .nav-section {
      padding: 1.4rem 1.6rem 0.6rem;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted-strong);
    }

    .nav-list {
      padding: 0 0.9rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .nav-list button {
      border: none;
      background: transparent;
      padding: 0.65rem 0.9rem;
      border-radius: var(--radius-sm);
      text-align: left;
      font-weight: 500;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.55rem;
      letter-spacing: 0.01em;
    }

    .nav-list button:hover,
    .nav-list button.active {
      background: rgba(37, 99, 235, 0.12);
      color: var(--accent);
      box-shadow: inset 0 0 0 1px rgba(37, 99, 235, 0.18);
    }

    .tree {
      flex: 1;
      overflow-y: auto;
      padding: 0 1.2rem 1.5rem;
      scrollbar-width: thin;
    }

    .tree-item {
      padding: 0.45rem 0.55rem;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      gap: 0.45rem;
      cursor: pointer;
      color: var(--muted);
      font-size: 0.92rem;
      transition: all 0.2s ease;
    }

    .tree-item.active,
    .tree-item:hover {
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
    }

    .tree-item .caret {
      width: 14px;
      font-size: 0.75rem;
      text-align: center;
      color: #94a3b8;
    }
    .tree-item .caret.invisible {
      color: transparent;
    }

    main {
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      min-height: 0;
    }

    .crumbs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .crumbs button {
      border: none;
      background: rgba(148, 163, 184, 0.18);
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      font-weight: 500;
      cursor: pointer;
      color: inherit;
    }

    .crumbs button:hover {
      background: rgba(37, 99, 235, 0.2);
      color: var(--accent);
    }

    .workspace-head {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 1.2rem;
      align-items: flex-end;
      padding: 1.4rem 1.6rem;
      background: rgba(255, 255, 255, 0.92);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(148, 163, 184, 0.16);
    }

    .workspace-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .workspace-actions button {
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(255, 255, 255, 0.9);
      border-radius: var(--radius-sm);
      padding: 0.55rem 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }

    .workspace-actions button:hover {
      border-color: rgba(37, 99, 235, 0.35);
      color: var(--accent);
    }

    .workspace-actions button.primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 6px 18px rgba(37, 99, 235, 0.35);
    }

    .workspace-actions button.primary:hover {
      background: var(--accent-strong);
    }

    .table-card {
      background: var(--surface);
      border: 1px solid rgba(148, 163, 184, 0.16);
      border-radius: var(--radius-lg);
      overflow: hidden;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-md);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    thead {
      background: #f1f5f9;
    }

    th, td {
      padding: 0.8rem 1rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    tbody tr:hover td {
      background: rgba(241, 245, 249, 0.65);
    }

    tbody tr.selected td {
      background: rgba(37, 99, 235, 0.12);
      border-bottom-color: rgba(37, 99, 235, 0.25);
    }

    td button {
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(249, 250, 251, 0.8);
      border-radius: var(--radius-sm);
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      margin-left: 0.35rem;
      transition: all 0.2s ease;
    }

    td button:hover {
      border-color: rgba(37, 99, 235, 0.35);
      color: var(--accent);
      background: rgba(237, 242, 255, 0.7);
    }

    #doc-table-empty {
      padding: 2rem;
      text-align: center;
      color: var(--muted);
      display: none;
    }

    .auth-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.4);
      backdrop-filter: blur(14px);
      padding: 2.5rem;
      z-index: 20;
    }

    .auth-card {
      width: min(460px, 100%);
      background: rgba(255, 255, 255, 0.96);
      border-radius: var(--radius-lg);
      padding: 2.4rem;
      box-shadow: 0 26px 48px rgba(15, 23, 42, 0.25);
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    input[type="email"],
    input[type="password"],
    input[type="text"],
    input[type="search"] {
      width: 100%;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.45);
      padding: 0.7rem 0.9rem;
      font-size: 0.9rem;
      font-family: inherit;
      background: rgba(255, 255, 255, 0.95);
      transition: all 0.2s ease;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
    }

    .hidden { display: none !important; }

    body.authed .auth-overlay { display: none; }

    @media (max-width: 992px) {
      .shell {
        grid-template-columns: 1fr;
        padding: 1.2rem;
      }
      aside {
        display: none;
      }
      .workspace-head {
        padding: 1.1rem;
      }
      .workspace-actions {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      .workspace-actions button {
        width: 100%;
      }
      header {
        padding: 1rem 1.2rem;
      }
    }
  </style>
</head>
<body>
  <div class="auth-overlay" id="auth-overlay">
    <div class="auth-card">
      <h2>Welcome to VeriCase Docs</h2>
      <p style="color: var(--muted); margin: 0;">Sign in to access your folders and documents. You can also paste an existing API token.</p>
      <input type="email" id="email" placeholder="Email address">
      <input type="password" id="pwd" placeholder="Password">
      <div style="display:flex; gap:0.6rem;">
        <button id="login" class="btn-primary" style="flex:1;">Log In</button>
        <button id="signup" class="btn-secondary" style="flex:1;">Sign Up</button>
      </div>
      <div>
        <button id="advancedToggle" class="link-button" type="button">Use an existing API token</button>
        <div id="advancedPanel" class="hidden" style="margin-top:0.75rem;">
          <label for="token" style="font-size:0.75rem; font-weight:600; color:var(--muted); text-transform:uppercase;">Token</label>
          <div style="display:flex; gap:0.5rem; margin-top:0.35rem;">
            <input type="text" id="token" placeholder="Bearer token">
            <button id="saveToken" class="btn-secondary">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <header>
    <div class="logo">
      <img src="assets/vericase-logo.png" alt="VeriCase" style="height:42px;">
      <div style="display:flex; flex-direction:column;">
        <strong>Williamrogers File Server</strong>
        <span style="color:var(--muted); font-size:0.85rem;">Shared ¬∑ Welbourne (WR)</span>
      </div>
    </div>
    <div class="session">
      <span id="session-email"></span>
      <button id="signout" class="btn-secondary btn-small">Sign Out</button>
    </div>
  </header>

  <div class="shell">
    <aside>
      <div class="nav-section">Navigation</div>
      <div class="nav-list">
        <button class="active">üìÅ Files</button>
        <button>üïò Recent</button>
        <button>‚≠ê Favorites</button>
        <button>üîó Links</button>
        <button>üóë Trash</button>
      </div>

      <div class="nav-section">Folders</div>
      <div class="tree" id="path-tree">
        <!-- folders injected here -->
      </div>
    </aside>

    <main>
      <div class="workspace-head">
        <div>
          <div class="crumbs" id="breadcrumbs"></div>
          <div>
            <h1 id="folder-title" style="margin:0.6rem 0 0.2rem;">All Documents</h1>
            <div id="library-status" class="muted"></div>
          </div>
        </div>
        <div class="workspace-actions">
          <button id="toolbar-upload" class="primary">+ Upload</button>
          <button id="toolbar-preview" disabled>Preview</button>
          <button id="toolbar-share" disabled>Share</button>
          <button id="toolbar-delete" disabled>Delete</button>
          <button id="library-reload">Reload</button>
          <div style="display:flex; gap:0.4rem; align-items:center;">
            <input type="search" id="library-search" placeholder="Search in this folder" style="width:200px;">
            <button id="library-search-btn">Search</button>
          </div>
        </div>
      </div>

      <div style="display:flex; gap:1rem; align-items:center;">
        <button id="library-prev" disabled>&larr; Prev</button>
        <span id="pagination-info" class="muted">Page 1</span>
        <button id="library-next" disabled>Next &rarr;</button>
      </div>

      <div class="table-card">
        <table>
          <thead>
            <tr>
              <th style="width:40px;"> </th>
              <th>Item name</th>
              <th>Status</th>
              <th>Size</th>
              <th>Date uploaded</th>
              <th>Updated by</th>
              <th style="text-align:right;">Actions</th>
            </tr>
          </thead>
          <tbody id="doc-table-body"></tbody>
        </table>
        <div id="doc-table-empty">No documents in this folder yet.</div>
      </div>
    </main>
  </div>

  <div id="upload-modal" class="hidden" style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(15,23,42,0.45); backdrop-filter:blur(8px);">
    <div style="background:rgba(255,255,255,0.96); border-radius:var(--radius-lg); width:min(460px, 100%); padding:1.9rem; display:flex; flex-direction:column; gap:1rem; box-shadow:var(--shadow-md);">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 style="margin:0;">Upload documents</h2>
        <button id="upload-close" style="border:none; background:transparent; font-size:1.6rem; cursor:pointer;">&times;</button>
      </div>
      <label for="path" style="font-size:0.75rem; font-weight:600; color:var(--muted); text-transform:uppercase;">Destination (optional)</label>
      <input type="text" id="path" placeholder="e.g., projects/acme/contracts">
      <div id="file-drop-area" style="border:2px dashed rgba(148,163,184,0.55); border-radius:var(--radius-lg); padding:2rem; text-align:center; cursor:pointer; background:rgba(248,250,252,0.8); transition:all 0.2s ease;">
        <input type="file" id="file" style="display:none;">
        <p style="margin:0; color:var(--muted); font-weight:500;">Click to browse or drag and drop</p>
        <p id="file-name" style="margin-top:0.6rem; font-weight:600;"></p>
      </div>
      <button id="upload" class="btn-primary">Start upload</button>
      <div id="upout"></div>
    </div>
  </div>

  <div id="search-drawer" class="hidden" style="position:fixed; top:0; right:0; width:min(420px,100%); height:100%; background:var(--surface); border-left:1px solid var(--border); box-shadow:-12px 0 24px rgba(15,23,42,0.12); display:flex; flex-direction:column;">
    <div style="padding:1.2rem; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0;">Search results</h2>
      <button id="search-close" style="border:none; background:transparent; font-size:1.6rem; cursor:pointer;">&times;</button>
    </div>
    <div id="results" style="flex:1; overflow-y:auto; padding:1.2rem;"></div>
  </div>

  <script>
    const appRoot = document.body;
    const base = window.location.origin.replace(/\\/$/, '').replace('/ui', '');

    const emailInput = document.getElementById('email');
    const pwdInput = document.getElementById('pwd');
    if (emailInput && !emailInput.value) emailInput.value = `user-${Date.now()}@example.com`;
    if (pwdInput && !pwdInput.value) pwdInput.value = 'StrongPass123!';

    const tokenInput = document.getElementById('token');
    const advancedToggle = document.getElementById('advancedToggle');
    const advancedPanel = document.getElementById('advancedPanel');
    const sessionEmail = document.getElementById('session-email');
    const signoutBtn = document.getElementById('signout');
    const treeContainer = document.getElementById('path-tree');
    const breadcrumbsEl = document.getElementById('breadcrumbs');
    const folderTitleEl = document.getElementById('folder-title');
    const libraryStatusEl = document.getElementById('library-status');
    const paginationInfo = document.getElementById('pagination-info');
    const docTableBody = document.getElementById('doc-table-body');
    const docTableEmpty = document.getElementById('doc-table-empty');

    const libraryPrev = document.getElementById('library-prev');
    const libraryNext = document.getElementById('library-next');
    const libraryReload = document.getElementById('library-reload');
    const toolbarUpload = document.getElementById('toolbar-upload');
    const toolbarPreview = document.getElementById('toolbar-preview');
    const toolbarShare = document.getElementById('toolbar-share');
    const toolbarDelete = document.getElementById('toolbar-delete');
    const searchDrawer = document.getElementById('search-drawer');
    const searchClose = document.getElementById('search-close');
    const searchInput = document.getElementById('library-search');
    const searchButton = document.getElementById('library-search-btn');

    const uploadModal = document.getElementById('upload-modal');
    const uploadClose = document.getElementById('upload-close');
    const fileDropArea = document.getElementById('file-drop-area');
    const fileInput = document.getElementById('file');
    const fileNameDisplay = document.getElementById('file-name');
    const uploadButton = document.getElementById('upload');
    const uploadOutput = document.getElementById('upout');
    const pathInput = document.getElementById('path');

    let token = localStorage.getItem('jwt') || '';
    let currentUserEmail = localStorage.getItem('userEmail') || '';
    let currentPath = '';
    let currentPage = 0;
    let totalDocuments = 0;
    const pageSize = 20;
    const selectedDocs = new Set();
    const expandedPaths = new Set(['']);
    let pathsCache = [];

    function expandAncestors(path) {
      if (!path) return;
      const parts = path.split('/').filter(Boolean);
      let prefix = '';
      parts.forEach(part => {
        prefix = prefix ? `${prefix}/${part}` : part;
        expandedPaths.add(prefix);
      });
    }

    function toggleTreePath(path) {
      if (!path) return;
      if (expandedPaths.has(path)) expandedPaths.delete(path);
      else expandedPaths.add(path);
      renderPaths(pathsCache);
    }

    function updateSessionEmail() {
      if (!sessionEmail) return;
      if (currentUserEmail) sessionEmail.textContent = currentUserEmail;
      else if (token) sessionEmail.textContent = 'Authenticated via token';
      else sessionEmail.textContent = '';
    }

    function renderBreadcrumbs(path) {
      if (!breadcrumbsEl) return;
      breadcrumbsEl.innerHTML = '';
      const segments = (path || '').split('/').filter(Boolean);
      const crumbs = [{ label: 'Shared', value: '' }];
      let prefix = '';
      segments.forEach(seg => {
        prefix = prefix ? prefix + '/' + seg : seg;
        crumbs.push({ label: seg, value: prefix });
      });
      crumbs.forEach((crumb, idx) => {
        const btn = document.createElement('button');
        btn.textContent = crumb.label || 'All documents';
        if (idx === crumbs.length - 1) {
          btn.disabled = true;
        } else {
          btn.addEventListener('click', () => {
            currentPage = 0;
            setActivePath(crumb.value);
            loadDocuments(true);
          });
        }
        breadcrumbsEl.appendChild(btn);
      });
    }

    function buildTree(paths) {
      const root = {};
      (paths || []).forEach(path => {
        if (!path) return;
        const parts = path.split('/').filter(Boolean);
        let node = root;
        let prefix = '';
        parts.forEach(part => {
          prefix = prefix ? prefix + '/' + part : part;
          if (!node[part]) node[part] = { path: prefix, children: {} };
          node = node[part].children;
        });
      });
      return root;
    }

    function createTreeNode(label, node, depth = 0) {
      const wrapper = document.createElement('div');
      const item = document.createElement('div');
      item.className = 'tree-item';
      item.dataset.path = node.path;
      item.style.paddingLeft = `${depth * 12 + 6}px`;

      const caret = document.createElement('span');
      caret.className = 'caret';

      const icon = document.createElement('span');
      icon.textContent = 'üìÅ';

      const text = document.createElement('span');
      text.textContent = label;

      const children = Object.keys(node.children).sort();
      const isExpanded = expandedPaths.has(node.path);

      if (children.length) {
        caret.textContent = isExpanded ? '‚ñæ' : '‚ñ∏';
        caret.addEventListener('click', (event) => {
          event.stopPropagation();
          toggleTreePath(node.path);
        });
      } else {
        caret.textContent = '‚ñ∏';
        caret.classList.add('invisible');
      }

      item.append(caret, icon, text);
      item.addEventListener('click', () => {
        currentPage = 0;
        setActivePath(node.path);
        loadDocuments(true);
      });
      wrapper.appendChild(item);

      if (children.length) {
        const container = document.createElement('div');
        container.style.marginLeft = '12px';
        container.style.display = isExpanded ? 'block' : 'none';
        children.forEach(child => {
          container.appendChild(createTreeNode(child, node.children[child], depth + 1));
        });
        wrapper.appendChild(container);
      }

      return wrapper;
    }

    function renderPaths(paths) {
      if (!treeContainer) return;
      pathsCache = Array.isArray(paths) ? paths.slice() : [];
      treeContainer.innerHTML = '';
      const all = document.createElement('div');
      all.className = 'tree-item';
      all.dataset.path = '';
      all.textContent = 'üóÇ All documents';
      all.addEventListener('click', () => {
        currentPage = 0;
        setActivePath('');
        loadDocuments(true);
      });
      treeContainer.appendChild(all);

      const tree = buildTree(pathsCache);
      expandAncestors(currentPath);
      Object.keys(tree).sort().forEach(name => {
        treeContainer.appendChild(createTreeNode(name, tree[name]));
      });

      setActivePath(currentPath || '');
    }

    function formatBytes(size) {
      if (!size || size <= 0) return '-';
      const units = ['B', 'KB', 'MB', 'GB'];
      let value = size;
      let unit = 0;
      while (value >= 1024 && unit < units.length - 1) {
        value /= 1024;
        unit += 1;
      }
      return `${value.toFixed(value < 10 ? 1 : 0)} ${units[unit]}`;
    }

    function setActivePath(path) {
      currentPath = path || '';
      expandedPaths.add('');
      expandAncestors(currentPath);
      if (folderTitleEl) folderTitleEl.textContent = currentPath ? currentPath.split('/').pop() : 'All Documents';
      renderBreadcrumbs(currentPath);
      if (treeContainer) {
        treeContainer.querySelectorAll('.tree-item').forEach(item => {
          item.classList.toggle('active', item.dataset.path === currentPath);
        });
      }
    }

    function updateToolbarState() {
      const hasSelection = selectedDocs.size > 0;
      if (toolbarPreview) toolbarPreview.disabled = !hasSelection;
      if (toolbarShare) toolbarShare.disabled = !hasSelection;
      if (toolbarDelete) toolbarDelete.disabled = !hasSelection;
    }

    function renderDocumentRows(items) {
      if (!docTableBody) return;
      const currentIds = new Set((items || []).map(doc => doc.id));
      Array.from(selectedDocs).forEach(id => {
        if (!currentIds.has(id)) selectedDocs.delete(id);
      });
      updateToolbarState();

      docTableBody.innerHTML = '';
      if (!items || items.length === 0) {
        docTableEmpty.style.display = 'block';
        return;
      }
      docTableEmpty.style.display = 'none';

      items.forEach(doc => {
        const tr = document.createElement('tr');
        tr.dataset.id = doc.id;

        const selectTd = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'row-select';
        if (selectedDocs.has(doc.id)) {
          checkbox.checked = true;
          tr.classList.add('selected');
        }
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            selectedDocs.add(doc.id);
            tr.classList.add('selected');
          } else {
            selectedDocs.delete(doc.id);
            tr.classList.remove('selected');
          }
          updateToolbarState();
        });
        selectTd.appendChild(checkbox);
        tr.appendChild(selectTd);

        const nameTd = document.createElement('td');
        nameTd.textContent = doc.filename;
        tr.appendChild(nameTd);

        const statusTd = document.createElement('td');
        statusTd.textContent = doc.status || '-';
        tr.appendChild(statusTd);

        const sizeTd = document.createElement('td');
        sizeTd.textContent = formatBytes(doc.size);
        tr.appendChild(sizeTd);

        const createdTd = document.createElement('td');
        createdTd.textContent = doc.created_at ? new Date(doc.created_at).toLocaleString() : '‚Äî';
        tr.appendChild(createdTd);

        const updatedByTd = document.createElement('td');
        updatedByTd.textContent = currentUserEmail || 'You';
        tr.appendChild(updatedByTd);

        const actionsTd = document.createElement('td');
        actionsTd.style.textAlign = 'right';
        actionsTd.innerHTML = `
          <button class="action-preview" data-id="${doc.id}">Preview</button>
          <button class="action-share" data-id="${doc.id}">Share</button>
          <button class="action-delete" data-id="${doc.id}">Delete</button>
        `;
        tr.appendChild(actionsTd);

        tr.addEventListener('click', (event) => {
          if (event.target.tagName === 'BUTTON' || event.target.type === 'checkbox') return;
          const isSelected = selectedDocs.has(doc.id);
          if (isSelected) {
            selectedDocs.delete(doc.id);
            if (checkbox.checked) checkbox.checked = false;
            tr.classList.remove('selected');
          } else {
            selectedDocs.add(doc.id);
            if (!checkbox.checked) checkbox.checked = true;
            tr.classList.add('selected');
          }
          updateToolbarState();
        });

        docTableBody.appendChild(tr);
      });

      attachRowActions();
    }

    function showStatus(id, message, type) {
      const container = document.getElementById(id);
      if (!container) return;
      container.innerHTML = `<div class="status-card status-${type || 'info'}">${message}</div>`;
    }

    async function api(path, method = 'GET', body = null) {
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = 'Bearer ' + token;
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);
      const response = await fetch(base + path, options);
      if (!response.ok) {
        const text = await response.text();
        throw new Error(`API Error: ${response.status} ${response.statusText} - ${text}`);
      }
      if (response.status === 204) return null;
      return response.json();
    }

    async function loadDocuments(reset = false) {
      if (!token || !docTableBody) return;
      if (reset) currentPage = 0;
      if (libraryStatusEl) libraryStatusEl.textContent = 'Loading documents...';
      const params = new URLSearchParams();
      params.set('limit', pageSize);
      params.set('offset', currentPage * pageSize);
      if (currentPath) params.set('path_prefix', currentPath);
      try {
        const res = await api('/documents?' + params.toString());
        totalDocuments = res.total || 0;
        if (libraryStatusEl) {
          const start = totalDocuments ? currentPage * pageSize + 1 : 0;
          const end = Math.min(totalDocuments, (currentPage + 1) * pageSize);
          libraryStatusEl.textContent = totalDocuments
            ? `${totalDocuments} documents ‚Ä¢ showing ${start}-${end}`
            : 'No documents yet.';
        }
        if (paginationInfo) {
          const totalPages = totalDocuments ? Math.ceil(totalDocuments / pageSize) : 1;
          paginationInfo.textContent = `Page ${totalDocuments ? currentPage + 1 : 0} of ${totalPages}`;
        }
        if (libraryPrev) libraryPrev.disabled = currentPage === 0;
        if (libraryNext) libraryNext.disabled = (currentPage + 1) * pageSize >= totalDocuments;
        renderDocumentRows(res.items || []);
      } catch (err) {
        if (libraryStatusEl) libraryStatusEl.textContent = 'Unable to load documents.';
      }
    }

    async function loadPaths() {
      if (!token || !treeContainer) return;
      try {
        const res = await api('/documents/paths');
        renderPaths(res.paths || []);
      } catch (err) {
        console.warn('Unable to load paths', err);
      }
    }

    function enterAuthenticatedView(scroll = true) {
      if (!token) return;
      appRoot.classList.add('authed');
      updateSessionEmail();
      if (advancedPanel && !advancedPanel.classList.contains('hidden')) advancedPanel.classList.add('hidden');
      loadPaths();
      loadDocuments(true);
      if (scroll) window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function leaveAuthenticatedView(message) {
      token = '';
      currentUserEmail = '';
      localStorage.removeItem('jwt');
      localStorage.removeItem('userEmail');
      if (tokenInput) tokenInput.value = '';
      appRoot.classList.remove('authed');
      currentPath = '';
      currentPage = 0;
      totalDocuments = 0;
      selectedDocs.clear();
      updateToolbarState();
      if (docTableBody) docTableBody.innerHTML = '';
      docTableEmpty.style.display = 'none';
      if (libraryStatusEl) libraryStatusEl.textContent = '';
      if (paginationInfo) paginationInfo.textContent = 'Page 1';
      renderBreadcrumbs('');
      if (treeContainer) treeContainer.innerHTML = '';
      updateSessionEmail();
      if (message) alert(message);
    }

    function attachRowActions() {
      document.querySelectorAll('.action-preview').forEach(btn => {
        btn.addEventListener('click', () => handlePreview(btn.dataset.id));
      });
      document.querySelectorAll('.action-share').forEach(btn => {
        btn.addEventListener('click', () => handleShare(btn.dataset.id));
      });
      document.querySelectorAll('.action-delete').forEach(btn => {
        btn.addEventListener('click', () => handleDelete(btn.dataset.id));
      });
    }

    function handlePreview(id) {
      if (!id) { alert('Select a document first.'); return; }
      api('/documents/' + id + '/signed_url')
        .then(r => window.open('pdf-viewer.html?file=' + encodeURIComponent(r.url), '_blank'))
        .catch(err => alert(err.message));
    }

    function handleShare(id) {
      if (!id) { alert('Select a document first.'); return; }
      const password = prompt('Optional password for share (blank for none):');
      if (password === null) return;
      const payload = { document_id: id };
      if (password.trim()) payload.password = password.trim();
      api('/shares', 'POST', payload)
        .then(res => {
          const url = `${window.location.origin}/ui/public-viewer.html?token=${res.token}`;
          alert(`Share link:\n${url}\n\nPassword required: ${res.requires_password ? 'Yes' : 'No'}`);
        })
        .catch(err => alert(err.message));
    }

    function handleDelete(id) {
      if (!id) { alert('Select a document first.'); return; }
      if (!confirm('Delete this document? This cannot be undone.')) return;
      api('/documents/' + id, 'DELETE')
        .then(() => loadDocuments(true))
        .catch(err => alert(err.message));
    }

    function primarySelection() {
      return selectedDocs.values().next().value;
    }

    if (libraryPrev) {
      libraryPrev.addEventListener('click', () => {
        if (currentPage > 0) {
          currentPage -= 1;
          loadDocuments();
        }
      });
    }
    if (libraryNext) {
      libraryNext.addEventListener('click', () => {
        const maxItems = (currentPage + 1) * pageSize;
        if (maxItems < totalDocuments) {
          currentPage += 1;
          loadDocuments();
        }
      });
    }
    if (libraryReload) {
      libraryReload.addEventListener('click', () => {
        loadPaths();
        loadDocuments(true);
      });
    }

    document.getElementById('saveToken').addEventListener('click', () => {
      const rawToken = tokenInput ? tokenInput.value.trim() : '';
      if (!rawToken) {
        leaveAuthenticatedView('Token cleared.');
        return;
      }
      token = rawToken;
      currentUserEmail = '';
      localStorage.setItem('jwt', token);
      localStorage.removeItem('userEmail');
      alert('Token saved. Loading workspace...');
      enterAuthenticatedView();
    });

    document.getElementById('signup').addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const pwd = pwdInput.value.trim();
      if (!email || !pwd) { alert('Provide email and password.'); return; }
      try {
        const res = await api('/auth/signup','POST',{ email, password: pwd });
        token = res.token;
        currentUserEmail = (res && res.user && res.user.email) ? res.user.email : email;
        localStorage.setItem('jwt', token);
        localStorage.setItem('userEmail', currentUserEmail);
        if (tokenInput) tokenInput.value = token;
        alert('Signed up. Loading workspace...');
        enterAuthenticatedView();
      } catch (err) {
        alert(err.message);
      }
    });

    document.getElementById('login').addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const pwd = pwdInput.value.trim();
      if (!email || !pwd) { alert('Provide email and password.'); return; }
      try {
        const res = await api('/auth/login','POST',{ email, password: pwd });
        token = res.token;
        currentUserEmail = (res && res.user && res.user.email) ? res.user.email : email;
        localStorage.setItem('jwt', token);
        localStorage.setItem('userEmail', currentUserEmail);
        if (tokenInput) tokenInput.value = token;
        alert('Logged in. Loading workspace...');

        enterAuthenticatedView();
      } catch (err) {
        alert(err.message);
      }
    });

    if (advancedToggle && advancedPanel) {
      advancedToggle.addEventListener('click', () => {
        const hidden = advancedPanel.classList.toggle('hidden');
        advancedToggle.textContent = hidden ? 'Use an existing API token' : 'Hide token input';
        if (!hidden && tokenInput && token) tokenInput.value = token;
      });
    }

    if (signoutBtn) {
      signoutBtn.addEventListener('click', () => leaveAuthenticatedView('Signed out.'));
    }

    if (toolbarUpload) toolbarUpload.addEventListener('click', () => token ? uploadModal.classList.remove('hidden') : alert('Sign in first.'));
    if (uploadClose) uploadClose.addEventListener('click', () => uploadModal.classList.add('hidden'));

    if (toolbarPreview) toolbarPreview.addEventListener('click', () => handlePreview(primarySelection()));
    if (toolbarShare) toolbarShare.addEventListener('click', () => handleShare(primarySelection()));
    if (toolbarDelete) toolbarDelete.addEventListener('click', () => handleDelete(primarySelection()));

    function openSearchDrawer() { searchDrawer.classList.remove('hidden'); }
    function closeSearchDrawer() {
      searchDrawer.classList.add('hidden');
      const resultsEl = document.getElementById('results');
      if (resultsEl) resultsEl.innerHTML = '';
    }
    if (searchClose) searchClose.addEventListener('click', closeSearchDrawer);

    if (searchButton) {
      searchButton.addEventListener('click', async () => {
        if (!token) { alert('Sign in to search.'); return; }
        const q = searchInput.value.trim();
        if (!q) { alert('Enter a search term.'); return; }
        openSearchDrawer();
        const resultsEl = document.getElementById('results');
        if (resultsEl) resultsEl.innerHTML = '<p class="muted">Searching...</p>';
        try {
          const params = new URLSearchParams({ q });
          if (currentPath) params.set('path_prefix', currentPath);
          const res = await api('/search?' + params.toString());
          if (!resultsEl) return;
          resultsEl.innerHTML = `<div class="muted">${res.count} results found</div>`;
          if (res.hits.length === 0) {
            resultsEl.innerHTML += '<div class="muted" style="margin-top:0.75rem;">No documents matched your query.</div>';
          }
          res.hits.forEach(hit => {
            const card = document.createElement('div');
            card.style.border = '1px solid var(--border)';
            card.style.borderRadius = '10px';
            card.style.padding = '0.9rem';
            card.style.marginTop = '0.85rem';
            card.innerHTML = `
              <strong>${hit.title || hit.filename}</strong>
              ${hit.path ? `<div class="muted">${hit.path}</div>` : ''}
              <div class="muted" style="margin-top:0.4rem;">${hit.snippet || 'No snippet available.'}</div>
              <div style="margin-top:0.6rem; display:flex; gap:0.5rem;">
                <button class="action-preview" data-id="${hit.id}">Preview</button>
                <button class="action-share" data-id="${hit.id}">Share</button>
              </div>
            `;
            resultsEl.appendChild(card);
          });
          attachRowActions();
        } catch (err) {
          if (resultsEl) resultsEl.innerHTML = `<div class="muted">Search failed: ${err.message}</div>`;
        }
      });
    }

    if (searchInput) {
      searchInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchButton.click();
        }
      });
    }

    if (fileDropArea) {
      fileDropArea.addEventListener('click', () => { if (fileInput) fileInput.click(); });
      fileDropArea.addEventListener('dragover', e => e.preventDefault());
      fileDropArea.addEventListener('drop', e => {
        e.preventDefault();
        if (fileInput && e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          fileNameDisplay.textContent = `Selected: ${fileInput.files[0].name}`;
        }
      });
    }
    if (fileInput) {
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length) fileNameDisplay.textContent = `Selected: ${fileInput.files[0].name}`;
        else fileNameDisplay.textContent = '';
      });
    }
    if (uploadButton) {
      uploadButton.addEventListener('click', async () => {
        if (!token) { alert('Sign in first.'); return; }
        if (!fileInput || !fileInput.files.length) { alert('Select a file to upload.'); return; }
        const file = fileInput.files[0];
        const path = pathInput.value.trim();
        showStatus('upout', 'Preparing upload...', 'info');
        try {
          const presign = await api('/uploads/presign','POST',{ filename: file.name, content_type: file.type || 'application/octet-stream', path });
          showStatus('upout', 'Uploading...', 'info');
          const put = await fetch(presign.url, { method:'PUT', headers:{ 'Content-Type': file.type || 'application/octet-stream' }, body: file })