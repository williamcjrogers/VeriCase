<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Secure Document Viewer</title>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; background:#0f172a; color:#e2e8f0; display:flex; align-items:center; justify-content:center; min-height:100vh; }
    .card { background:#1e293b; padding:2rem; border-radius:12px; box-shadow:0 15px 40px rgba(15,23,42,.3); width:min(420px, 92vw); border:1px solid rgba(148,163,184,.2); }
    h1 { font-size:1.3rem; margin:0 0 1.5rem 0; font-weight:600; text-align:center; }
    label { display:block; font-size:0.85rem; color:#94a3b8; margin-bottom:0.4rem; }
    input { width:100%; padding:0.6rem 0.75rem; border-radius:8px; border:1px solid rgba(148,163,184,.25); background:#0f172a; color:#e2e8f0; margin-bottom:1rem; font-size:1rem; }
    input:focus { outline:none; border-color:#38bdf8; box-shadow:0 0 0 3px rgba(56,189,248,.25); }
    button { width:100%; padding:0.65rem 1rem; border-radius:8px; border:none; font-weight:600; background:#38bdf8; color:#0f172a; cursor:pointer; transition:transform .15s ease, box-shadow .2s; }
    button:hover { transform:translateY(-1px); box-shadow:0 10px 25px rgba(56,189,248,.35); }
    .muted { font-size:0.85rem; color:#94a3b8; margin-top:1rem; text-align:center; }
    .error { color:#f87171; }
  </style>
</head>
<body>
  <div class="card" id="gate">
    <h1>Access Shared Document</h1>
    <form id="unlock">
      <label for="password">Password (if provided)</label>
      <input type="password" id="password" autocomplete="off" placeholder="Enter password to unlock" />
      <label for="watermark">Watermark (optional for PDFs)</label>
      <input type="text" id="watermark" maxlength="120" placeholder="e.g. Case Reference / Recipient" />
      <button type="submit">Open document</button>
    </form>
    <div class="muted" id="status"></div>
  </div>
  <script>
    const params = new URLSearchParams(location.search);
    const token = params.get('token');
    const initialPwd = params.get('password') || '';
    const initialWatermark = params.get('watermark') || '';
    const base = location.origin.replace(/\/$/, '');
    const statusEl = document.getElementById('status');
    const pwdInput = document.getElementById('password');
    const wmInput = document.getElementById('watermark');
    if (!token) {
      statusEl.textContent = 'Token missing.';
      document.getElementById('unlock').style.display = 'none';
      throw new Error('No token supplied');
    }
    if (initialPwd) pwdInput.value = initialPwd;
    if (initialWatermark) wmInput.value = initialWatermark;

    async function openDocument(passwordOverride) {
      const searchParams = new URLSearchParams();
      if (passwordOverride) searchParams.set('password', passwordOverride);
      const watermarkText = wmInput.value.trim();
      if (watermarkText) searchParams.set('watermark', watermarkText);
      statusEl.textContent = 'Requesting document...';
      const url = `${base}/shares/${token}?${searchParams.toString()}`;
      const resp = await fetch(url);
      if (resp.status === 401) {
        statusEl.textContent = 'Password required to unlock this document.';
        statusEl.classList.add('error');
        return;
      }
      if (!resp.ok) {
        statusEl.textContent = 'Link is invalid or expired.';
        statusEl.classList.add('error');
        return;
      }
      const payload = await resp.json();
      const redirect = `${base}/ui/pdf-viewer.html?file=${encodeURIComponent(payload.url)}`;
      window.location.replace(redirect);
    }

    document.getElementById('unlock').addEventListener('submit', (ev) => {
      ev.preventDefault();
      statusEl.classList.remove('error');
      openDocument(pwdInput.value.trim());
    });

    // Try automatic open if password not required
    if (initialPwd || !initialPwd && !params.has('password')) {
      openDocument(initialPwd).catch(() => { /* handled in status */ });
    }
  </script>
</body>
</html>
