<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Correspondence Analysis - VeriCase</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f6fb;
      --surface: #ffffff;
      --text: #111827;
      --muted: #64748b;
      --border: #e2e8f0;
      --accent: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow-sm: 0 2px 6px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #edf2fb 0%, #f8fafc 45%, #eef2ff 100%);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.1rem;
      font-weight: 700;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 2rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .search-bar {
      flex: 1;
      max-width: 500px;
      position: relative;
    }

    .search-bar input {
      width: 100%;
      padding: 0.625rem 2.5rem 0.625rem 1rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: 'Inter', sans-serif;
    }

    .search-bar input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn {
      padding: 0.625rem 1.25rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--bg);
    }

    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .table-container {
      flex: 1;
      overflow: auto;
      background: var(--surface);
      border-right: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f8fafc;
      z-index: 10;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    th {
      padding: 0.75rem 0.5rem;
      text-align: left;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }

    th.sortable {
      cursor: pointer;
      user-select: none;
    }

    th.sortable:hover {
      color: var(--accent);
    }

    td {
      padding: 0.75rem 0.5rem;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    tbody tr {
      cursor: pointer;
      transition: background 0.15s;
    }

    tbody tr:hover {
      background: rgba(37, 99, 235, 0.04);
    }

    tbody tr.selected {
      background: rgba(37, 99, 235, 0.08);
    }

    .email-from, .email-to {
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .subject-cell {
      max-width: 250px;
      font-weight: 500;
    }

    .body-excerpt {
      max-width: 300px;
      color: var(--muted);
      font-size: 0.8rem;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .programme-cell {
      font-size: 0.75rem;
      min-width: 140px;
    }

    .programme-date {
      font-weight: 600;
      color: var(--text);
      display: block;
      margin-bottom: 0.25rem;
    }

    .programme-activity {
      color: var(--muted);
      font-size: 0.7rem;
    }

    .delay-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-top: 0.25rem;
    }

    .delay-badge.critical {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }

    .delay-badge.warning {
      background: rgba(245, 158, 11, 0.1);
      color: #d97706;
    }

    .delay-badge.ok {
      background: rgba(16, 185, 129, 0.1);
      color: #059669;
    }

    .attachments {
      display: flex;
      gap: 0.25rem;
      margin-top: 0.25rem;
      flex-wrap: wrap;
    }

    .attachment-badge {
      background: rgba(37, 99, 235, 0.1);
      color: var(--accent);
      padding: 0.125rem 0.375rem;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 500;
    }

    .preview-panel {
      width: 450px;
      background: var(--surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .preview-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .preview-header h3 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .preview-meta {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .preview-meta-row {
      display: flex;
      gap: 0.5rem;
    }

    .preview-meta-label {
      font-weight: 600;
      color: var(--text);
      min-width: 60px;
    }

    .preview-body {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      font-size: 0.85rem;
      line-height: 1.6;
    }

    .preview-actions {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.5rem;
    }

    .link-section {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      background: var(--bg);
    }

    .link-section h4 {
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .linked-item {
      padding: 0.5rem;
      background: var(--surface);
      border-radius: 6px;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
    }

    .linked-item-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .linked-item-meta {
      color: var(--muted);
      font-size: 0.75rem;
    }

    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: var(--muted);
      padding: 2rem;
      text-align: center;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }

    .stats-bar {
      display: flex;
      gap: 2rem;
      padding: 0.5rem 0;
      font-size: 0.8rem;
    }

    .stat {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .stat-label {
      color: var(--muted);
    }

    .stat-value {
      font-weight: 600;
      color: var(--text);
    }

    .filter-chips {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .filter-chip {
      padding: 0.375rem 0.75rem;
      background: rgba(37, 99, 235, 0.08);
      border: 1px solid rgba(37, 99, 235, 0.2);
      border-radius: 20px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }

    .filter-chip.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .thread-indicator {
      display: inline-block;
      width: 3px;
      height: 100%;
      background: var(--accent);
      position: absolute;
      left: 0;
      top: 0;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <span>üìß</span>
      <span>Correspondence Analysis</span>
    </div>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <button class="btn btn-secondary" onclick="window.location.href='cases.html'">‚Üê Back to Cases</button>
      <span id="session-email" style="color: var(--muted); font-size: 0.85rem;"></span>
      <button class="btn btn-secondary" id="signout">Sign Out</button>
    </div>
  </header>

  <div class="toolbar">
    <div class="search-bar">
      <input type="text" id="search-input" placeholder="Search correspondence by subject, sender, content...">
    </div>
    <div class="stats-bar">
      <div class="stat">
        <span class="stat-label">Total:</span>
        <span class="stat-value" id="total-count">0</span>
      </div>
      <div class="stat">
        <span class="stat-label">Delays Linked:</span>
        <span class="stat-value" id="delays-count">0</span>
      </div>
    </div>
    <button class="btn btn-primary" id="upload-programmes">üìä Upload Programmes</button>
    <button class="btn btn-secondary" id="export-btn">‚¨áÔ∏è Export</button>
  </div>

  <div style="padding: 0.75rem 2rem; background: var(--surface); border-bottom: 1px solid var(--border);">
    <div class="filter-chips">
      <div class="filter-chip active" data-filter="all">All Correspondence</div>
      <div class="filter-chip" data-filter="email">üìß Emails</div>
      <div class="filter-chip" data-filter="with-delays">‚ö†Ô∏è With Delays</div>
      <div class="filter-chip" data-filter="critical">üî¥ Critical Path</div>
      <div class="filter-chip" data-filter="unlinked">üîó Unlinked</div>
    </div>
  </div>

  <div class="main-container">
    <div class="table-container">
      <table id="correspondence-table">
        <thead>
          <tr>
            <th class="sortable" data-sort="date" style="width: 100px;">Date</th>
            <th class="sortable" data-sort="from">From</th>
            <th class="sortable" data-sort="to">To</th>
            <th style="width: 80px;">CC</th>
            <th class="sortable" data-sort="subject">Subject</th>
            <th style="width: 300px;">Body (Excerpt)</th>
            <th style="width: 140px;">As-Planned</th>
            <th style="width: 140px;">As-Built</th>
            <th style="width: 100px;">Slippage</th>
            <th style="width: 120px;">Attachments</th>
          </tr>
        </thead>
        <tbody id="correspondence-tbody">
          <!-- Data will be loaded here -->
        </tbody>
      </table>
    </div>

    <div class="preview-panel" id="preview-panel">
      <div class="empty-state">
        <div class="empty-state-icon">üì®</div>
        <p>Select correspondence to view details</p>
      </div>
    </div>
  </div>

  <!-- Upload Programmes Modal -->
  <div id="upload-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--surface); border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%;">
      <h3 style="margin-bottom: 1.5rem;">Upload Programme Files</h3>
      
      <div style="margin-bottom: 1rem;">
        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Programme Type</label>
        <select id="programme-type" style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 8px; font-family: 'Inter', sans-serif;">
          <option value="as_planned">As-Planned (Baseline)</option>
          <option value="as_built">As-Built (Current)</option>
          <option value="interim">Interim Update</option>
        </select>
      </div>

      <div style="margin-bottom: 1rem;">
        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Programme Date</label>
        <input type="date" id="programme-date" style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 8px; font-family: 'Inter', sans-serif;">
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Version Number</label>
        <input type="text" id="version-number" placeholder="e.g. Rev A, Issue 3" style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 8px; font-family: 'Inter', sans-serif;">
      </div>

      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">File (Asta .pp, .xml, or PDF)</label>
        <input type="file" id="programme-file" accept=".pp,.xml,.pdf" style="width: 100%; padding: 0.625rem; border: 1px solid var(--border); border-radius: 8px; font-family: 'Inter', sans-serif;">
        <p style="font-size: 0.75rem; color: var(--muted); margin-top: 0.5rem;">
          Supported: Asta Powerproject (.pp, .xml), PDF schedules
        </p>
      </div>

      <div style="display: flex; gap: 0.75rem;">
        <button class="btn btn-primary" id="upload-confirm" style="flex: 1;">Upload</button>
        <button class="btn btn-secondary" id="upload-cancel" style="flex: 1;">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    const token = localStorage.getItem('token');
    
    if (!token) {
      window.location.href = 'analysis.html';
    }

    let currentCaseId = null;
    let correspondenceData = [];
    let selectedRow = null;
    let currentFilter = 'all';

    // Get case ID from URL params
    const urlParams = new URLSearchParams(window.location.search);
    currentCaseId = urlParams.get('case_id');

    if (!currentCaseId) {
      alert('No case selected. Redirecting...');
      window.location.href = 'analysis.html';
    }

    // API helper
    async function api(endpoint, method = 'GET', body = null) {
      const options = {
        method,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      };
      
      if (body) {
        options.body = JSON.stringify(body);
      }
      
      const response = await fetch(`${API_BASE}${endpoint}`, options);
      
      if (!response.ok) {
        if (response.status === 401) {
          localStorage.removeItem('token');
          window.location.href = 'analysis.html';
        }
        throw new Error(`API error: ${response.statusText}`);
      }
      
      return response.json();
    }

    // Load correspondence (evidence with email metadata)
    async function loadCorrespondence() {
      try {
        const evidence = await api(`/api/cases/${currentCaseId}/evidence`);
        
        // Filter for email correspondence
        correspondenceData = evidence.filter(e => 
          e.evidence_type === 'email' || 
          e.document_filename?.toLowerCase().endsWith('.eml') ||
          e.document_filename?.toLowerCase().endsWith('.msg')
        );

        renderTable();
        updateStats();
      } catch (error) {
        console.error('Failed to load correspondence:', error);
      }
    }

    // Render table
    function renderTable() {
      const tbody = document.getElementById('correspondence-tbody');
      tbody.innerHTML = '';

      let filtered = correspondenceData;

      // Apply filters
      if (currentFilter !== 'all') {
        filtered = correspondenceData.filter(item => {
          if (currentFilter === 'email') return true; // All items are emails
          if (currentFilter === 'with-delays') return item.linked_delays && item.linked_delays.length > 0;
          if (currentFilter === 'critical') return item.is_critical_path;
          if (currentFilter === 'unlinked') return !item.linked_delays || item.linked_delays.length === 0;
          return true;
        });
      }

      filtered.forEach(item => {
        const row = document.createElement('tr');
        row.dataset.id = item.id;
        
        // Sample data structure - adapt based on your actual Evidence model
        const date = item.email_date ? new Date(item.email_date).toLocaleDateString('en-GB') : 
                     item.added_at ? new Date(item.added_at).toLocaleDateString('en-GB') : '-';
        
        const from = item.email_from || 'Unknown';
        const to = item.email_to || 'Unknown';
        const subject = item.email_subject || item.document_filename || 'No Subject';
        // Read content from metadata field where pst_processor stores it
        const content = item.meta?.content || item.metadata?.content || item.content || '';
        const excerpt = content ? content.substring(0, 200).replace(/<[^>]*>/g, '') : item.notes || 'No preview available';
        
        // Mock programme data - will be replaced with actual API data
        const asPlanned = item.as_planned_date ? {
          date: new Date(item.as_planned_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }),
          activity: item.as_planned_activity || 'Activity pending'
        } : null;
        
        const asBuilt = item.as_built_date ? {
          date: new Date(item.as_built_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }),
          activity: item.as_built_activity || 'Activity pending'
        } : null;
        
        const slippage = item.delay_days || 0;
        
        row.innerHTML = `
          <td>${date}</td>
          <td class="email-from" title="${from}">${from}</td>
          <td class="email-to" title="${to}">${to}</td>
          <td>-</td>
          <td class="subject-cell">${subject}</td>
          <td class="body-excerpt">${excerpt}</td>
          <td class="programme-cell">
            ${asPlanned ? `
              <span class="programme-date">${asPlanned.date}</span>
              <span class="programme-activity">${asPlanned.activity}</span>
            ` : '<span style="color: var(--muted);">Not linked</span>'}
          </td>
          <td class="programme-cell">
            ${asBuilt ? `
              <span class="programme-date">${asBuilt.date}</span>
              <span class="programme-activity">${asBuilt.activity}</span>
            ` : '<span style="color: var(--muted);">Not linked</span>'}
          </td>
          <td>
            ${slippage > 0 ? `
              <span class="delay-badge ${slippage > 10 ? 'critical' : 'warning'}">
                +${slippage}d
              </span>
            ` : slippage < 0 ? `
              <span class="delay-badge ok">${slippage}d</span>
            ` : '-'}
          </td>
          <td>
            ${item.attachments ? `
              <div class="attachments">
                ${item.attachments.split(',').slice(0, 2).map(att => 
                  `<span class="attachment-badge">${att.trim()}</span>`
                ).join('')}
                ${item.attachments.split(',').length > 2 ? 
                  `<span class="attachment-badge">+${item.attachments.split(',').length - 2}</span>` : ''}
              </div>
            ` : 'none'}
          </td>
        `;
        
        row.addEventListener('click', () => selectRow(item, row));
        tbody.appendChild(row);
      });
    }

    // Select row and show preview
    function selectRow(item, rowElement) {
      // Remove previous selection
      document.querySelectorAll('tbody tr').forEach(tr => tr.classList.remove('selected'));
      rowElement.classList.add('selected');
      
      selectedRow = item;
      renderPreview(item);
    }

    // Render preview panel
    function renderPreview(item) {
      const panel = document.getElementById('preview-panel');
      
      panel.innerHTML = `
        <div class="preview-header">
          <h3>${item.email_subject || item.document_filename || 'Correspondence'}</h3>
          <div class="preview-meta">
            <div class="preview-meta-row">
              <span class="preview-meta-label">From:</span>
              <span>${item.email_from || 'Unknown'}</span>
            </div>
            <div class="preview-meta-row">
              <span class="preview-meta-label">To:</span>
              <span>${item.email_to || 'Unknown'}</span>
            </div>
            <div class="preview-meta-row">
              <span class="preview-meta-label">Date:</span>
              <span>${item.email_date ? new Date(item.email_date).toLocaleString('en-GB') : 'Unknown'}</span>
            </div>
            <div class="preview-meta-row">
              <span class="preview-meta-label">Document:</span>
              <span>${item.document_filename}</span>
            </div>
          </div>
        </div>
        
        <div class="preview-body">
          <div style="max-height: 400px; overflow-y: auto; padding: 1rem; background: var(--background); border-radius: 8px;">
            ${(item.meta?.content_type || item.metadata?.content_type === 'html' || item.content_type === 'html') && (item.meta?.content || item.metadata?.content || item.content) ? 
              `<div style="font-family: inherit;">${item.meta?.content || item.metadata?.content || item.content}</div>` : 
              (item.meta?.content || item.metadata?.content || item.content) ? 
              `<pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${item.meta?.content || item.metadata?.content || item.content}</pre>` :
              '<p style="color: var(--muted);">No email content available</p>'
            }
          </div>
          ${item.notes ? `
            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--surface); border-left: 3px solid var(--primary); border-radius: 4px;">
              <strong style="font-size: 0.875rem; color: var(--muted);">Notes:</strong>
              <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem;">${item.notes}</p>
            </div>
          ` : ''}
        </div>

        <div class="link-section">
          <h4>Programme Links</h4>
          <div id="programme-links">
            ${item.linked_delays && item.linked_delays.length > 0 ? 
              item.linked_delays.map(delay => `
                <div class="linked-item">
                  <div class="linked-item-title">${delay.activity_name}</div>
                  <div class="linked-item-meta">Delay: ${delay.delay_days} days ‚Ä¢ ${delay.delay_cause || 'Uncategorized'}</div>
                </div>
              `).join('') :
              '<p style="color: var(--muted); font-size: 0.8rem;">No delays linked to this correspondence</p>'
            }
          </div>
          <button class="btn btn-secondary" style="width: 100%; margin-top: 0.75rem;" onclick="linkToProgramme()">
            üîó Link to Programme Activity
          </button>
        </div>

        <div class="preview-actions">
          <button class="btn btn-primary" onclick="openDocument('${item.document_id}')">Open Document</button>
          <button class="btn btn-secondary" onclick="linkToIssue('${item.id}')">Link to Issue</button>
        </div>
      `;
    }

    // Update stats
    function updateStats() {
      document.getElementById('total-count').textContent = correspondenceData.length;
      document.getElementById('delays-count').textContent = 
        correspondenceData.filter(item => item.linked_delays && item.linked_delays.length > 0).length;
    }

    // Filter chips
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        currentFilter = chip.dataset.filter;
        renderTable();
      });
    });

    // Search
    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const query = e.target.value.toLowerCase();
        if (!query) {
          renderTable();
          return;
        }
        
        const filtered = correspondenceData.filter(item => 
          (item.email_subject && item.email_subject.toLowerCase().includes(query)) ||
          (item.email_from && item.email_from.toLowerCase().includes(query)) ||
          (item.email_to && item.email_to.toLowerCase().includes(query)) ||
          (item.notes && item.notes.toLowerCase().includes(query)) ||
          (item.document_filename && item.document_filename.toLowerCase().includes(query))
        );
        
        correspondenceData = filtered;
        renderTable();
      }, 300);
    });

    // Upload programmes modal
    document.getElementById('upload-programmes').addEventListener('click', () => {
      document.getElementById('upload-modal').style.display = 'flex';
    });

    document.getElementById('upload-cancel').addEventListener('click', () => {
      document.getElementById('upload-modal').style.display = 'none';
    });

    document.getElementById('upload-confirm').addEventListener('click', async () => {
      const type = document.getElementById('programme-type').value;
      const date = document.getElementById('programme-date').value;
      const version = document.getElementById('version-number').value;
      const file = document.getElementById('programme-file').files[0];
      
      if (!file || !date) {
        alert('Please select a file and date');
        return;
      }
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('case_id', currentCaseId);
      formData.append('programme_type', type);
      formData.append('programme_date', date);
      formData.append('version_number', version);
      
      try {
        const response = await fetch(`${API_BASE}/api/programmes/upload`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });
        
        if (response.ok) {
          alert('Programme uploaded successfully!');
          document.getElementById('upload-modal').style.display = 'none';
          loadCorrespondence(); // Reload to show new programme data
        } else {
          alert('Upload failed: ' + await response.text());
        }
      } catch (error) {
        alert('Upload error: ' + error.message);
      }
    });

    // Export
    document.getElementById('export-btn').addEventListener('click', () => {
      // Export to CSV
      const headers = ['Date', 'From', 'To', 'Subject', 'As-Planned', 'As-Built', 'Slippage'];
      const rows = correspondenceData.map(item => [
        item.email_date || item.added_at || '',
        item.email_from || '',
        item.email_to || '',
        item.email_subject || item.document_filename || '',
        item.as_planned_date || '',
        item.as_built_date || '',
        item.delay_days || 0
      ]);
      
      const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `correspondence_analysis_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    });

    // Helper functions
    function openDocument(docId) {
      window.open(`/documents/${docId}`, '_blank');
    }

    function linkToIssue(evidenceId) {
      alert('Link to Issue feature coming soon');
      // Will open modal to select issue
    }

    function linkToProgramme() {
      alert('Link to Programme Activity feature coming soon');
      // Will open modal to select activity from programme
    }

    // Sign out
    document.getElementById('signout').addEventListener('click', () => {
      localStorage.removeItem('token');
      localStorage.removeItem('email');
      window.location.href = 'analysis.html';
    });

    // Load user email
    const email = localStorage.getItem('email');
    if (email) {
      document.getElementById('session-email').textContent = email;
    }

    // Initialize
    loadCorrespondence();
  </script>
</body>
</html>
