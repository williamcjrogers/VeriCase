<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VeriCase Docs - File Manager</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      display: grid;
      grid-template-rows: 60px 1fr;
      height: 100vh;
      background: #f5f5f5;
    }
    
    header {
      background: white;
      border-bottom: 1px solid #e0e0e0;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    header h1 {
      font-size: 18px;
      color: #333;
    }
    
    header .user-info {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    header button {
      padding: 8px 16px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    header button:hover {
      background: #1d4ed8;
    }
    
    .main-grid {
      display: grid;
      grid-template-columns: 250px 1fr 600px;
      height: 100%;
      overflow: hidden;
    }
    
    .folders-panel {
      background: white;
      border-right: 1px solid #e0e0e0;
      padding: 20px;
      overflow-y: auto;
    }
    
    .folders-panel h3 {
      margin-bottom: 15px;
      color: #333;
      font-size: 14px;
      text-transform: uppercase;
      color: #666;
    }
    
    .folder-item {
      padding: 10px;
      cursor: pointer;
      border-radius: 6px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .folder-item:hover {
      background: #f0f7ff;
    }
    
    .folder-item.active {
      background: #e0f2fe;
      font-weight: 600;
      color: #2563eb;
    }
    
    .files-panel {
      background: white;
      padding: 20px;
      overflow-y: auto;
    }
    
    .files-panel h2 {
      margin-bottom: 20px;
      color: #333;
      font-size: 20px;
    }
    
    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .toolbar button {
      padding: 8px 16px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .toolbar button:hover {
      background: #1d4ed8;
    }
    
    .file-item {
      padding: 12px;
      border: 1px solid #e0e0e0;
      margin-bottom: 8px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .file-item:hover {
      background: #f0f7ff;
      border-color: #2563eb;
    }
    
    .file-icon {
      font-size: 24px;
    }
    
    .file-info {
      flex: 1;
    }
    
    .file-name {
      font-weight: 600;
      color: #333;
    }
    
    .file-meta {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    
    .preview-panel {
      background: white;
      border-left: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
    }
    
    .preview-header {
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
    }
    
    .preview-header h3 {
      font-size: 14px;
      color: #666;
      font-weight: 600;
    }
    
    .close-btn {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
      line-height: 1;
    }
    
    .close-btn:hover {
      color: #333;
    }
    
    .preview-body {
      flex: 1;
      overflow: hidden;
      position: relative;
    }
    
    .preview-body iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
      gap: 15px;
    }
    
    .empty-state svg {
      width: 64px;
      height: 64px;
      opacity: 0.5;
    }
    
    .status-msg {
      padding: 12px;
      background: #f0f7ff;
      border: 1px solid #2563eb;
      border-radius: 6px;
      margin-bottom: 15px;
      color: #1d4ed8;
    }
    
    .auth-screen {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .auth-card {
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .auth-card h2 {
      margin-bottom: 20px;
    }
    
    .auth-card input {
      width: 100%;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .auth-card button {
      width: 100%;
      padding: 12px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    
    .auth-card button:hover {
      background: #1d4ed8;
    }
    
    body.authenticated .auth-screen {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-screen" id="auth-screen">
    <div class="auth-card">
      <h2>Sign In</h2>
      <input type="email" id="email" placeholder="Email" value="william.rogers@quantumcommercialsolutions.com">
      <input type="password" id="password" placeholder="Password" value="password">
      <button onclick="login()">Log In</button>
    </div>
  </div>

  <!-- Main App -->
  <header>
    <h1>üìÅ VeriCase Docs</h1>
    <div class="user-info">
      <span id="user-email"></span>
      <button onclick="logout()">Sign Out</button>
    </div>
  </header>

  <div class="main-grid">
    <!-- Left: Folders -->
    <div class="folders-panel">
      <h3>Folders</h3>
      <div class="folder-item active" onclick="loadFolder('')">
        üìÇ All Files
      </div>
      <div id="folder-list"></div>
    </div>

    <!-- Middle: Files -->
    <div class="files-panel">
      <h2 id="current-folder-title">All Files</h2>
      <div class="toolbar">
        <button onclick="uploadFile()">+ Upload</button>
        <button onclick="newFolder()">+ New Folder</button>
        <button onclick="loadDocuments()">‚ü≥ Refresh</button>
      </div>
      <div id="status-msg"></div>
      <div id="file-list"></div>
    </div>

    <!-- Right: Preview -->
    <div class="preview-panel">
      <div class="preview-header">
        <h3 id="preview-title">Select a file to preview</h3>
        <button class="close-btn" onclick="closePreview()">‚úï</button>
      </div>
      <div class="preview-body">
        <div class="empty-state" id="empty-state">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <p>Click a file to preview it here</p>
        </div>
        <iframe id="preview-frame" style="display: none;"></iframe>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let token = localStorage.getItem('jwt') || '';
    let currentPath = '';
    let userEmail = localStorage.getItem('userEmail') || '';

    // Auth functions
    async function login() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      
      try {
        const res = await fetch(API_BASE + '/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        if (!res.ok) throw new Error('Login failed');
        
        const data = await res.json();
        token = data.token;
        userEmail = email;
        localStorage.setItem('jwt', token);
        localStorage.setItem('userEmail', userEmail);
        
        document.body.classList.add('authenticated');
        document.getElementById('user-email').textContent = userEmail;
        
        loadFolders();
        loadDocuments();
      } catch (err) {
        alert('Login failed: ' + err.message);
      }
    }
    
    function logout() {
      token = '';
      userEmail = '';
      localStorage.removeItem('jwt');
      localStorage.removeItem('userEmail');
      document.body.classList.remove('authenticated');
      window.location.reload();
    }

    // API helper
    async function api(path, method = 'GET', body = null) {
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = 'Bearer ' + token;
      
      const options = { method, headers };
      if (body) options.body = JSON.stringify(body);
      
      const response = await fetch(API_BASE + path, options);
      if (!response.ok) {
        const text = await response.text();
        throw new Error(`${response.status}: ${text}`);
      }
      if (response.status === 204) return null;
      return response.json();
    }

    // Load folders
    async function loadFolders() {
      try {
        const data = await api('/folders');
        const folders = data.folders || [];
        
        const html = folders.map(f => `
          <div class="folder-item" onclick="loadFolder('${f.name}')">
            üìÅ ${f.name}
          </div>
        `).join('');
        
        document.getElementById('folder-list').innerHTML = html;
      } catch (err) {
        console.error('Failed to load folders:', err);
      }
    }

    // Load documents
    async function loadDocuments() {
      try {
        const data = await api('/documents' + (currentPath ? `?folder=${encodeURIComponent(currentPath)}` : ''));
        const documents = data.documents || [];
        
        const html = documents.map(doc => `
          <div class="file-item" onclick="previewFile('${doc.document_id}', '${doc.filename}')">
            <div class="file-icon">üìÑ</div>
            <div class="file-info">
              <div class="file-name">${doc.filename}</div>
              <div class="file-meta">${formatDate(doc.created_at)} ‚Ä¢ ${formatSize(doc.size_bytes)}</div>
            </div>
          </div>
        `).join('');
        
        document.getElementById('file-list').innerHTML = html || '<p style="color: #999;">No files in this folder</p>';
      } catch (err) {
        console.error('Failed to load documents:', err);
        showStatus('Failed to load documents: ' + err.message, 'error');
      }
    }

    // Load specific folder
    function loadFolder(path) {
      currentPath = path;
      document.getElementById('current-folder-title').textContent = path || 'All Files';
      
      // Update active state
      document.querySelectorAll('.folder-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.classList.add('active');
      
      loadDocuments();
    }

    // Preview file
    function previewFile(docId, filename) {
      document.getElementById('preview-title').textContent = filename;
      document.getElementById('empty-state').style.display = 'none';
      
      const frame = document.getElementById('preview-frame');
      frame.style.display = 'block';
      frame.src = API_BASE + '/documents/' + docId + '/view?token=' + token;
    }

    // Close preview
    function closePreview() {
      document.getElementById('preview-title').textContent = 'Select a file to preview';
      document.getElementById('empty-state').style.display = 'flex';
      document.getElementById('preview-frame').style.display = 'none';
    }

    // Upload file
    async function uploadFile() {
      const input = document.createElement('input');
      input.type = 'file';
      input.multiple = true;
      
      input.onchange = async (e) => {
        const files = e.target.files;
        if (!files.length) return;
        
        showStatus('Uploading files...', 'info');
        
        for (const file of files) {
          try {
            const formData = new FormData();
            formData.append('file', file);
            if (currentPath) formData.append('folder', currentPath);
            
            const res = await fetch(API_BASE + '/documents/upload', {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + token },
              body: formData
            });
            
            if (!res.ok) throw new Error('Upload failed');
          } catch (err) {
            showStatus('Failed to upload: ' + err.message, 'error');
            return;
          }
        }
        
        showStatus('Files uploaded successfully!', 'success');
        loadDocuments();
      };
      
      input.click();
    }

    // New folder
    async function newFolder() {
      const name = prompt('Enter folder name:');
      if (!name) return;
      
      try {
        await api('/folders', 'POST', { name, parent: currentPath || null });
        showStatus('Folder created!', 'success');
        loadFolders();
      } catch (err) {
        showStatus('Failed to create folder: ' + err.message, 'error');
      }
    }

    // Show status message
    function showStatus(message, type) {
      const div = document.getElementById('status-msg');
      div.textContent = message;
      div.className = 'status-msg ' + type;
      div.style.display = 'block';
      
      setTimeout(() => {
        div.style.display = 'none';
      }, 3000);
    }

    // Format helpers
    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown date';
      const date = new Date(dateStr);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatSize(bytes) {
      if (!bytes) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Initialize
    if (token && userEmail) {
      document.body.classList.add('authenticated');
      document.getElementById('user-email').textContent = userEmail;
      loadFolders();
      loadDocuments();
    }
  </script>
</body>
</html>
